
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Mesh Pro | Ultimate Edition</title>
    <!-- Library Imports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- CORE DISCORD DESIGN SYSTEM --- */
        @font-face {
            font-family: 'gg sans';
            src: url('https://fonts.cdnfonts.com/css/gg-sans');
        }

        :root {
            --bg-guilds: #1e1f22;
            --bg-sidebar: #2b2d31;
            --bg-chat: #313338;
            --bg-members: #2b2d31;
            --bg-overlay: rgba(0, 0, 0, 0.85);
            --bg-modifier-hover: rgba(78, 80, 88, 0.3);
            --bg-modifier-selected: rgba(78, 80, 88, 0.6);
            
            --text-normal: #dbdee1;
            --text-muted: #949ba4;
            --text-header: #ffffff;
            --text-link: #00a8fc;
            --text-positive: #23a55a;
            --text-danger: #f23f43;
            
            --brand: #5865f2;
            --brand-hover: #4752c4;
            --success: #23a55a;
            --danger: #f23f43;
            --warning: #f0b232;
            
            --header-height: 48px;
            --guild-width: 72px;
            --sidebar-width: 240px;
            --members-width: 240px;
            
            --font-main: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --scrollbar-thumb: #1a1b1e;
            --scrollbar-track: #2e3338;
        }

        /* Basic Resets */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            height: 100vh; width: 100vw; overflow: hidden; 
            background: var(--bg-guilds); font-family: var(--font-main); 
            color: var(--text-normal); line-height: 1.2;
            -webkit-user-select: none; user-select: none;
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb:hover { background: #111; }

        /* --- LAYOUT UTILS --- */
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .cursor-pointer { cursor: pointer; }
        .transition-standard { transition: all 0.2s ease; }

        /* --- MAIN COMPONENTS --- */
        .app-container { display: flex; height: 100vh; width: 100vw; }

        /* Guild Navigation */
        .guilds-nav { 
            width: var(--guild-width); background: var(--bg-guilds); 
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 12px; gap: 8px; flex-shrink: 0; overflow-y: auto;
            scrollbar-width: none;
        }
        .guilds-nav::-webkit-scrollbar { display: none; }
        
        .guild-item { position: relative; width: 100%; display: flex; justify-content: center; }
        .guild-pill { 
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 4px; height: 8px; background: white; border-radius: 0 4px 4px 0; 
            transition: 0.2s; opacity: 0;
        }
        .guild-item:hover .guild-pill { opacity: 0.5; height: 20px; }
        .guild-item.active .guild-pill { opacity: 1; height: 40px; }

        .guild-icon {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--bg-sidebar); display: flex;
            align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; color: var(--text-normal);
            font-size: 18px; font-weight: 500; overflow: hidden;
            background-size: cover; background-position: center;
        }
        .guild-icon:hover { border-radius: 16px; background: var(--brand); color: white; }
        .guild-item.active .guild-icon { border-radius: 16px; background: var(--brand); color: white; }
        
        .nav-separator { width: 32px; height: 2px; background: #35363c; margin: 4px 0; }

        /* Sidebar & Channel List */
        .sidebar { 
            width: var(--sidebar-width); background: var(--bg-sidebar); 
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header {
            height: var(--header-height); padding: 0 16px;
            display: flex; align-items: center; justify-content: space-between;
            font-weight: 700; color: white; border-bottom: 1px solid rgba(0,0,0,0.2);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;
        }
        .sidebar-header:hover { background: var(--bg-modifier-hover); }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 12px 0; }
        .chan-cat {
            padding: 16px 8px 4px 16px; font-size: 12px; font-weight: 700;
            text-transform: uppercase; color: var(--text-muted);
            display: flex; align-items: center; cursor: pointer;
        }
        .chan-cat:hover { color: var(--text-normal); }
        .chan-cat i { font-size: 8px; margin-right: 4px; transition: 0.2s; }

        .chan-link {
            margin: 1px 8px; padding: 6px 8px; border-radius: 4px;
            display: flex; align-items: center; gap: 6px;
            cursor: pointer; color: var(--text-muted); font-size: 15px;
            position: relative;
        }
        .chan-link:hover { background: var(--bg-modifier-hover); color: var(--text-normal); }
        .chan-link.active { background: var(--bg-modifier-selected); color: white; }
        .chan-link i { font-size: 20px; opacity: 0.6; width: 24px; text-align: center; }

        /* User Dashboard (Bottom) */
        .user-dashboard {
            background: #232428; padding: 0 8px; height: 52px;
            display: flex; align-items: center; gap: 8px; flex-shrink: 0;
        }
        .u-avatar-wrap { position: relative; width: 32px; height: 32px; cursor: pointer; }
        .u-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--brand); background-size: cover; background-position: center; }
        .u-status { 
            position: absolute; bottom: -2px; right: -2px; 
            width: 10px; height: 10px; border-radius: 50%;
            border: 3px solid #232428; background: var(--success);
        }
        .u-info { flex: 1; min-width: 0; cursor: pointer; }
        .u-name { font-size: 13px; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .u-tag { font-size: 11px; color: var(--text-muted); }
        .u-actions { display: flex; align-items: center; }
        .u-action-btn { width: 32px; height: 32px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); }
        .u-action-btn:hover { background: var(--bg-modifier-hover); color: var(--text-normal); }
        .u-action-btn.active { color: var(--danger); }

        /* --- CHAT AREA --- */
        .chat-view { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); min-width: 0; position: relative; }
        .chat-header {
            height: var(--header-height); padding: 0 16px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.2); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .chat-header-left { display: flex; align-items: center; gap: 8px; font-weight: 700; color: white; }
        .chat-header-right { display: flex; align-items: center; gap: 16px; color: var(--text-muted); font-size: 20px; }
        
        .chat-body { display: flex; flex: 1; overflow: hidden; }
        .message-pane { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .message-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        .msg { 
            margin-top: 1.0625rem; padding: 2px 16px; display: flex; gap: 16px; position: relative; 
            transition: background 0.1s;
        }
        .msg:hover { background: rgba(0,0,0,0.05); }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--brand); flex-shrink: 0; cursor: pointer; background-size: cover; background-position: center; }
        .msg-content { flex: 1; min-width: 0; font-size: 1rem; }
        .msg-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .msg-username { font-weight: 600; color: white; cursor: pointer; }
        .msg-username:hover { text-decoration: underline; }
        .msg-timestamp { font-size: 0.75rem; color: var(--text-muted); }
        .msg-text { color: var(--text-normal); line-height: 1.375rem; white-space: pre-wrap; word-wrap: break-word; user-select: text; }

        /* Input Area */
        .input-area { padding: 0 16px 24px; flex-shrink: 0; }
        .input-box-wrapper {
            background: #383a40; border-radius: 8px; padding: 0 16px;
            display: flex; align-items: center; min-height: 44px; gap: 16px;
        }
        .input-plus-circle { 
            width: 24px; height: 24px; background: var(--text-muted); color: #383a40; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-size: 16px; transition: 0.2s;
        }
        .input-plus-circle:hover { background: white; }
        #chat-input-field {
            flex: 1; background: transparent; border: none; outline: none;
            color: var(--text-normal); font-size: 16px; padding: 11px 0;
        }

        /* Member List */
        .member-sidebar { width: var(--members-width); background: var(--bg-members); overflow-y: auto; flex-shrink: 0; padding: 24px 8px; }
        .member-group-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; padding: 0 8px 4px; margin-top: 10px; }
        .member-row {
            padding: 6px 8px; border-radius: 4px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; color: var(--text-muted); transition: 0.1s;
        }
        .member-row:hover { background: var(--bg-modifier-hover); color: var(--text-normal); }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--brand); background-size: cover; flex-shrink: 0; position: relative; }

        /* --- STAGE (VIDEO/VOICE) --- */
        #stage-overlay {
            display: none; position: absolute; inset: 0; background: #111214; 
            z-index: 100; flex-direction: column;
        }
        .stage-grid {
            flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px; padding: 24px; overflow-y: auto; align-content: center;
        }
        .peer-card {
            background: #1e1f22; border-radius: 12px; aspect-ratio: 16/10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden; border: 2px solid transparent;
        }
        .peer-card.speaking { border-color: var(--success); }
        .peer-video { width: 100%; height: 100%; object-fit: cover; }
        .peer-placeholder-av { width: 80px; height: 80px; border-radius: 50%; background: var(--brand); background-size: cover; }
        .peer-label { position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-weight: 700; color: white; }

        .stage-controls {
            height: 80px; display: flex; align-items: center; justify-content: center; gap: 16px;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
        }
        .stage-btn { width: 56px; height: 56px; border-radius: 50%; background: #313338; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; font-size: 20px; transition: 0.2s; }
        .stage-btn:hover { background: #43444b; transform: scale(1.05); }
        .stage-btn.active { background: white; color: black; }
        .stage-btn.hangup { background: var(--danger); }
        .stage-btn.hangup:hover { background: #c03135; }

        /* --- SEARCH OVERLAY --- */
        #search-overlay {
            display: none; position: fixed; inset: 0; background: var(--bg-overlay);
            z-index: 5000; padding: 100px 20px; flex-direction: column; align-items: center;
        }
        .search-modal {
            width: 100%; max-width: 570px; background: var(--bg-sidebar);
            border-radius: 8px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .search-input-wrap { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-input { width: 100%; background: #1e1f22; border: none; padding: 12px 16px; color: white; font-size: 18px; border-radius: 4px; outline: none; }
        .search-results { max-height: 400px; overflow-y: auto; padding: 8px; }
        .search-item { padding: 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); }
        .search-item:hover { background: var(--bg-modifier-hover); color: white; }

        /* --- SETTINGS LAYER --- */
        #settings-layer {
            display: none; position: fixed; inset: 0; background: var(--bg-sidebar); 
            z-index: 6000;
        }
        .settings-container { display: flex; height: 100%; }
        .settings-nav { 
            width: 30%; min-width: 240px; background: #2b2d31; 
            display: flex; flex-direction: column; padding: 60px 10px 20px 100px; text-align: right;
        }
        .settings-main { flex: 1; background: #313338; padding: 60px 40px; position: relative; overflow-y: auto; }
        .settings-close { position: absolute; right: 40px; top: 60px; text-align: center; cursor: pointer; }
        .close-btn-circle { width: 36px; height: 36px; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; color: var(--text-muted); }
        .settings-close:hover .close-btn-circle { color: white; border-color: white; }

        .settings-group-label { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        .settings-link { padding: 6px 10px; border-radius: 4px; color: var(--text-muted); cursor: pointer; margin-bottom: 2px; }
        .settings-link:hover { background: var(--bg-modifier-hover); color: var(--text-normal); }
        .settings-link.active { background: var(--bg-modifier-selected); color: white; }

        .form-group { margin-bottom: 24px; max-width: 600px; }
        .label-block { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
        .input-block { width: 100%; background: #1e1f22; border: none; padding: 12px; color: white; border-radius: 4px; outline: none; font-size: 16px; transition: 0.2s; }
        .input-block:focus { box-shadow: 0 0 0 2px var(--brand); }
        .save-btn { background: var(--brand); color: white; border: none; padding: 10px 28px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .save-btn:hover { background: var(--brand-hover); }

        /* Animation Classes */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Helpers */
        .hidden { display: none !important; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <!-- GUILDS NAVBAR -->
    <nav class="guilds-nav" id="guild-bar">
        <div class="guild-item active" data-view="home" onclick="App.UI.switchMainView('home', this)">
            <div class="guild-pill"></div>
            <div class="guild-icon flex-center"><i class="fa-brands fa-discord"></i></div>
        </div>
        <div class="nav-separator"></div>
        <div class="guild-item" data-view="server" onclick="App.UI.switchMainView('server', this)">
            <div class="guild-pill"></div>
            <div class="guild-icon flex-center">TM</div>
        </div>
        <div class="guild-item">
            <div class="guild-pill"></div>
            <div class="guild-icon flex-center" style="color:var(--success)"><i class="fa-solid fa-plus"></i></div>
        </div>
        <div class="guild-item">
            <div class="guild-pill"></div>
            <div class="guild-icon flex-center" style="color:var(--success)"><i class="fa-solid fa-compass"></i></div>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <!-- Default Server Sidebar -->
        <div id="sidebar-server-content">
            <div class="sidebar-header" onclick="App.UI.toggleServerMenu()">
                <span>TTG Mesh Ultimate</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="sidebar-content">
                <div class="chan-cat"><i class="fa-solid fa-chevron-down"></i> Text Channels</div>
                <div class="chan-link active"><i class="fa-solid fa-hashtag"></i> general</div>
                <div class="chan-link"><i class="fa-solid fa-hashtag"></i> dev-logs</div>
                <div class="chan-link"><i class="fa-solid fa-hashtag"></i> announcements</div>

                <div class="chan-cat"><i class="fa-solid fa-chevron-down"></i> Voice Channels</div>
                <div class="chan-link" onclick="App.Voice.join('Global Hub')">
                    <i class="fa-solid fa-volume-high"></i> Global Hub
                </div>
                <div id="voice-occupants" class="ml-8 flex flex-col gap-1 mb-4"></div>
                
                <div class="chan-link" onclick="App.Voice.join('Lounge')">
                    <i class="fa-solid fa-volume-high"></i> Lounge
                </div>
            </div>
        </div>

        <!-- Home/DM Sidebar -->
        <div id="sidebar-home-content" class="hidden h-full flex flex-col">
            <div class="sidebar-header">
                <div class="bg-[#1e1f22] rounded py-1 px-2 w-full text-sm text-[#949ba4] cursor-pointer" onclick="App.UI.toggleSearch(true)">Find or start a conversation</div>
            </div>
            <div class="sidebar-content">
                <div class="chan-link active"><i class="fa-solid fa-user-group"></i> Friends</div>
                <div class="chan-link"><i class="fa-solid fa-bolt"></i> Nitro</div>
                <div class="chan-link"><i class="fa-solid fa-shop"></i> Shop</div>
                
                <div class="chan-cat flex justify-between">
                    <span>Direct Messages</span>
                    <i class="fa-solid fa-plus cursor-pointer"></i>
                </div>
                <div class="chan-link"><div class="w-8 h-8 rounded-full bg-indigo-500 mr-2"></div> AI Support</div>
                <div class="chan-link"><div class="w-8 h-8 rounded-full bg-emerald-500 mr-2"></div> Mesh System</div>
            </div>
        </div>

        <!-- USER DASHBOARD -->
        <div class="user-dashboard">
            <div class="u-avatar-wrap" onclick="App.UI.toggleSettings(true)">
                <div id="my-u-avatar" class="u-avatar"></div>
                <div class="u-status"></div>
            </div>
            <div class="u-info" onclick="App.UI.toggleSettings(true)">
                <div id="my-u-name" class="u-name">Guest</div>
                <div id="my-u-tag" class="u-tag">#0000</div>
            </div>
            <div class="u-actions">
                <div class="u-action-btn" id="btn-mute" onclick="App.Voice.toggleMute()"><i class="fa-solid fa-microphone"></i></div>
                <div class="u-action-btn" id="btn-deaf" onclick="App.Voice.toggleDeafen()"><i class="fa-solid fa-headphones"></i></div>
                <div class="u-action-btn" onclick="App.UI.toggleSettings(true)"><i class="fa-solid fa-gear"></i></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="chat-view">
        
        <!-- TOP NAVIGATION BAR -->
        <header class="chat-header">
            <div class="chat-header-left">
                <i class="fa-solid fa-hashtag text-[#949ba4]"></i>
                <span id="header-channel-name">general</span>
            </div>
            <div class="chat-header-right">
                <i class="fa-solid fa-bell cursor-pointer hover:text-white" title="Notifications"></i>
                <i class="fa-solid fa-thumbtack cursor-pointer hover:text-white" title="Pinned Messages"></i>
                <i class="fa-solid fa-users cursor-pointer hover:text-white" title="Member List"></i>
                <div class="bg-[#1e1f22] rounded flex items-center px-2 py-0.5 text-sm">
                    <input type="text" placeholder="Search" class="bg-transparent border-none outline-none text-white w-32">
                    <i class="fa-solid fa-magnifying-glass text-xs"></i>
                </div>
                <i class="fa-solid fa-inbox cursor-pointer hover:text-white"></i>
                <i class="fa-solid fa-circle-question cursor-pointer hover:text-white"></i>
            </div>
        </header>

        <div class="chat-body">
            <!-- MESSAGE AREA -->
            <section class="message-pane">
                <div class="message-list" id="msg-container">
                    <!-- Welcome Block -->
                    <div class="p-8">
                        <div class="w-16 h-16 rounded-full bg-[#41434a] flex-center mb-4">
                            <i class="fa-solid fa-hashtag text-4xl text-white"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-white mb-2">Welcome to #general!</h1>
                        <p class="text-[#949ba4]">This is the beginning of the #general channel server history. Start a new mesh broadcast!</p>
                        <hr class="mt-6 border-white/5">
                    </div>
                    <!-- Live Messages go here -->
                    <div id="live-messages"></div>
                </div>

                <!-- CHAT INPUT -->
                <div class="input-area">
                    <div class="input-box-wrapper">
                        <div class="input-plus-circle"><i class="fa-solid fa-plus"></i></div>
                        <input type="text" id="chat-input-field" placeholder="Message #general">
                        <div class="flex gap-4 text-[#b5bac1] text-xl">
                            <i class="fa-solid fa-gift cursor-pointer hover:text-white"></i>
                            <i class="fa-solid fa-face-smile cursor-pointer hover:text-white"></i>
                        </div>
                    </div>
                    <div class="text-[10px] text-[#949ba4] mt-1 px-1">
                        <b>Pro Tip:</b> Press <span class="bg-[#1e1f22] px-1 rounded">Enter</span> to send, <span class="bg-[#1e1f22] px-1 rounded">Shift+Enter</span> for new line.
                    </div>
                </div>
            </section>

            <!-- MEMBERS SIDEBAR -->
            <aside class="member-sidebar">
                <div class="member-group-title">Online â€” <span id="count-online">1</span></div>
                <div id="list-online"></div>
                
                <div class="member-group-title">Offline</div>
                <div id="list-offline" class="opacity-50"></div>
            </aside>
        </div>

        <!-- STAGE / VOICE VIEW -->
        <div id="stage-overlay">
            <header class="chat-header bg-[#111214]">
                <div class="chat-header-left">
                    <i class="fa-solid fa-volume-high text-[#23a55a]"></i>
                    <span id="stage-title">Voice Hub</span>
                </div>
                <button class="bg-[#23a55a] text-white px-3 py-1 rounded text-sm font-bold hover:bg-[#1a8144]" onclick="App.Voice.toggleScreenShare()">Share Your Screen</button>
            </header>
            <div class="stage-grid" id="stage-grid"></div>
            <div class="stage-controls">
                <div class="stage-btn" id="stage-cam-btn" onclick="App.Voice.toggleCamera()"><i class="fa-solid fa-video"></i></div>
                <div class="stage-btn" id="stage-mic-btn" onclick="App.Voice.toggleMute()"><i class="fa-solid fa-microphone"></i></div>
                <div class="stage-btn hangup" onclick="App.Voice.leave()"><i class="fa-solid fa-phone-slash"></i></div>
            </div>
        </div>
    </main>
</div>

<!-- OVERLAYS -->
<div id="search-overlay" onclick="App.UI.toggleSearch(false)">
    <div class="search-modal slide-up" onclick="event.stopPropagation()">
        <div class="search-input-wrap">
            <input type="text" class="search-input" placeholder="Where would you like to go?" id="search-bar-input">
        </div>
        <div class="search-results">
            <div class="search-item"><i class="fa-solid fa-hashtag"></i> <span>general</span></div>
            <div class="search-item"><i class="fa-solid fa-hashtag"></i> <span>dev-logs</span></div>
            <div class="search-item"><i class="fa-solid fa-user"></i> <span>Add Friends</span></div>
        </div>
    </div>
</div>

<div id="settings-layer">
    <div class="settings-container">
        <nav class="settings-nav">
            <div class="settings-group-label">User Settings</div>
            <div class="settings-link active">My Account</div>
            <div class="settings-link">Profiles</div>
            <div class="settings-link">Privacy & Safety</div>
            <div class="settings-link">Family Center</div>
            <div class="settings-link">Authorized Apps</div>
            <div class="settings-link">Devices</div>
            <div class="settings-group-label mt-4">App Settings</div>
            <div class="settings-link">Appearance</div>
            <div class="settings-link">Accessibility</div>
            <div class="settings-link">Voice & Video</div>
            <div class="settings-link">Text & Images</div>
            <div class="h-[1px] bg-white/5 my-4"></div>
            <div class="settings-link text-red-400" onclick="App.Auth.logout()">Log Out</div>
        </nav>
        <main class="settings-main">
            <div class="settings-close" onclick="App.UI.toggleSettings(false)">
                <div class="close-btn-circle"><i class="fa-solid fa-xmark"></i></div>
                <div class="text-[12px] font-bold text-[#949ba4]">ESC</div>
            </div>
            
            <h2 class="text-white text-xl font-bold mb-6">My Account</h2>
            <div class="bg-[#1e1f22] rounded-lg p-6 mb-8 flex items-center gap-6">
                <div id="settings-av-preview" class="w-20 h-20 rounded-full bg-indigo-500 bg-cover bg-center"></div>
                <div class="flex-1">
                    <div class="text-xl font-bold text-white" id="settings-name-preview">Guest</div>
                    <div class="text-[#949ba4]" id="settings-tag-preview">#0000</div>
                </div>
                <button class="bg-[#4e5058] text-white px-4 py-2 rounded font-bold hover:bg-[#6d6f78]">Edit User Profile</button>
            </div>

            <div class="form-group">
                <label class="label-block">Username</label>
                <input type="text" id="set-username" class="input-block">
            </div>
            <div class="form-group">
                <label class="label-block">Avatar URL</label>
                <input type="text" id="set-avatar" class="input-block" placeholder="https://i.imgur.com/example.png">
            </div>
            <div class="form-group">
                <label class="label-block">Custom Status</label>
                <textarea class="input-block h-24 resize-none" placeholder="What's on your mind?"></textarea>
            </div>
            
            <button class="save-btn" onclick="App.Auth.saveProfile()">Save Changes</button>
        </main>
    </div>
</div>

<script>
/**
 * DISCORD MESH ULTIMATE - CORE APPLICATION LOGIC
 * Architecture: Modular Object Pattern
 * Features: MQTT Mesh Network, Audio/Video Simulation, State Management
 */

const App = {
    Config: {
        MQTT_HOST: "mqtt.flespi.io",
        MQTT_PORT: 443,
        MQTT_TOKEN: "g977bmKI5b1CdmpybeBxi4QfXcrGVva0oUvZc4mb9lhxNkIL3L2pXhIfhI7NP2J0",
        TOPIC_BASE: "ttg/mesh/discord/ultimate/v1",
        PRESENCE_INTERVAL: 4000
    },

    State: {
        user: {
            name: localStorage.getItem('dm_name') || "User_" + Math.random().toString(36).substr(2, 5),
            avatar: localStorage.getItem('dm_av') || "",
            id: localStorage.getItem('dm_id') || Math.random().toString(10).substr(2, 4),
            status: "online"
        },
        view: 'server',
        inVoice: false,
        activeRoom: null,
        isMuted: false,
        isDeafened: false,
        cameraActive: false,
        screenActive: false,
        peers: {}, // Remote users
        localStream: null,
        client: null
    },

    init() {
        console.log("Initializing Discord Mesh Ultimate...");
        this.Auth.updateIdentityUI();
        this.Network.connect();
        this.UI.setupListeners();
        
        // Background tasks
        setInterval(() => this.Network.broadcastPresence(), this.Config.PRESENCE_INTERVAL);
        setInterval(() => this.Network.cleanupPeers(), 10000);
    },

    /* --- NETWORK ENGINE (MQTT) --- */
    Network: {
        connect() {
            const cid = "DC_MESH_" + App.State.user.id + "_" + Date.now();
            App.State.client = new Paho.Client(App.Config.MQTT_HOST, App.Config.MQTT_PORT, cid);
            
            App.State.client.onMessageArrived = (msg) => {
                try {
                    const data = JSON.parse(msg.payloadString);
                    if(data.uid === App.State.user.id) return; // Ignore self

                    if(msg.destinationName.includes('/chat')) App.Chat.receive(data);
                    if(msg.destinationName.includes('/presence')) App.Network.handlePresence(data);
                } catch(e) { console.warn("MQTT Parse Err", e); }
            };

            const options = {
                useSSL: true, userName: App.Config.MQTT_TOKEN,
                onSuccess: () => {
                    App.State.client.subscribe(`${App.Config.TOPIC_BASE}/#`);
                    console.log("Connected to Mesh Mesh Network");
                },
                onFailure: (e) => console.error("MQTT Fail", e)
            };
            App.State.client.connect(options);
        },

        broadcastPresence() {
            if(!App.State.client?.connected) return;
            const payload = {
                uid: App.State.user.id,
                name: App.State.user.name,
                avatar: App.State.user.avatar,
                speaking: App.Voice.checkSpeaking(),
                muted: App.State.isMuted,
                deaf: App.State.isDeafened,
                video: App.State.cameraActive || App.State.screenActive,
                room: App.State.activeRoom,
                ts: Date.now()
            };
            const msg = new Paho.Message(JSON.stringify(payload));
            msg.destinationName = `${App.Config.TOPIC_BASE}/presence`;
            App.State.client.send(msg);
            App.UI.renderMembers();
        },

        handlePresence(data) {
            App.State.peers[data.uid] = { ...data, lastSeen: Date.now() };
            App.UI.renderMembers();
        },

        cleanupPeers() {
            const now = Date.now();
            for(let id in App.State.peers) {
                if(now - App.State.peers[id].lastSeen > 12000) delete App.State.peers[id];
            }
            App.UI.renderMembers();
        }
    },

    /* --- CHAT ENGINE --- */
    Chat: {
        send() {
            const field = document.getElementById('chat-input-field');
            const val = field.value.trim();
            if(!val || !App.State.client?.connected) return;

            const payload = {
                uid: App.State.user.id,
                author: App.State.user.name,
                avatar: App.State.user.avatar,
                content: val,
                ts: Date.now()
            };

            const msg = new Paho.Message(JSON.stringify(payload));
            msg.destinationName = `${App.Config.TOPIC_BASE}/chat`;
            App.State.client.send(msg);
            
            this.receive(payload); // Add to local UI
            field.value = "";
        },

        receive(data) {
            const list = document.getElementById('live-messages');
            const div = document.createElement('div');
            div.className = 'msg fade-in';
            
            const time = new Date(data.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const hasAv = data.avatar && data.avatar.startsWith('http');
            const avStyle = hasAv ? `background-image:url(${data.avatar})` : `background-color:var(--brand)`;

            div.innerHTML = `
                <div class="msg-avatar flex-center text-white font-bold" style="${avStyle}">${hasAv ? '' : data.author[0].toUpperCase()}</div>
                <div class="msg-content">
                    <div class="msg-meta">
                        <span class="msg-username">${data.author}</span>
                        <span class="msg-timestamp">Today at ${time}</span>
                    </div>
                    <div class="msg-text">${this.sanitize(data.content)}</div>
                </div>
            `;
            
            list.appendChild(div);
            const container = document.getElementById('msg-container');
            container.scrollTop = container.scrollHeight;
        },

        sanitize(text) {
            // Very simple markdown & security filter
            let s = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            // Highlight URLs
            s = s.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-400 hover:underline">$1</a>');
            // Bold
            s = s.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            return s;
        }
    },

    /* --- VOICE & VIDEO (Simulated/WebRTC-ready) --- */
    Voice: {
        audioContext: null,
        micStream: null,
        analyser: null,
        isCurrentlySpeaking: false,

        async join(room) {
            App.State.inVoice = true;
            App.State.activeRoom = room;
            document.getElementById('stage-title').innerText = room;
            document.getElementById('stage-overlay').style.display = 'flex';
            
            if(!this.audioContext) await this.initAudio();
            App.Network.broadcastPresence();
        },

        async initAudio() {
            try {
                this.micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = this.audioContext.createMediaStreamSource(this.micStream);
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 256;
                source.connect(this.analyser);
            } catch(e) { console.warn("Mic rejected", e); }
        },

        checkSpeaking() {
            if(!this.analyser || App.State.isMuted) return false;
            const data = new Uint8Array(this.analyser.frequencyBinCount);
            this.analyser.getByteFrequencyData(data);
            const average = data.reduce((a, b) => a + b) / data.length;
            return average > 25; // Sensitivity threshold
        },

        toggleMute() {
            App.State.isMuted = !App.State.isMuted;
            const icon = App.State.isMuted ? 'fa-microphone-slash' : 'fa-microphone';
            document.getElementById('btn-mute').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            document.getElementById('btn-mute').classList.toggle('active', App.State.isMuted);
            document.getElementById('stage-mic-btn').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            document.getElementById('stage-mic-btn').classList.toggle('active', App.State.isMuted);
            App.Network.broadcastPresence();
        },

        toggleDeafen() {
            App.State.isDeafened = !App.State.isDeafened;
            const icon = App.State.isDeafened ? 'fa-ear-slash' : 'fa-headphones';
            document.getElementById('btn-deaf').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            document.getElementById('btn-deaf').classList.toggle('active', App.State.isDeafened);
            if(App.State.isDeafened && !App.State.isMuted) this.toggleMute();
            App.Network.broadcastPresence();
        },

        async toggleCamera() {
            if(App.State.cameraActive) {
                App.State.localStream.getTracks().forEach(t => t.stop());
                App.State.cameraActive = false;
                document.getElementById('stage-cam-btn').classList.remove('active');
            } else {
                try {
                    App.State.localStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    App.State.cameraActive = true;
                    App.State.screenActive = false;
                    document.getElementById('stage-cam-btn').classList.add('active');
                } catch(e) { console.error("Cam Fail", e); }
            }
            App.Network.broadcastPresence();
        },

        async toggleScreenShare() {
            if(App.State.screenActive) {
                App.State.localStream.getTracks().forEach(t => t.stop());
                App.State.screenActive = false;
            } else {
                try {
                    App.State.localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    App.State.screenActive = true;
                    App.State.cameraActive = false;
                } catch(e) { console.error("Screen Fail", e); }
            }
            App.Network.broadcastPresence();
        },

        leave() {
            App.State.inVoice = false;
            App.State.activeRoom = null;
            if(App.State.localStream) App.State.localStream.getTracks().forEach(t => t.stop());
            document.getElementById('stage-overlay').style.display = 'none';
            App.Network.broadcastPresence();
        }
    },

    /* --- UI ENGINE --- */
    UI: {
        setupListeners() {
            const chatInp = document.getElementById('chat-input-field');
            chatInp.onkeydown = (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    App.Chat.send();
                }
            };

            // Keyboard Shortcuts
            window.onkeydown = (e) => {
                if(e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    this.toggleSearch(true);
                }
                if(e.key === 'Escape') this.closeAllOverlays();
            };
        },

        switchMainView(view, el) {
            App.State.view = view;
            
            // Toggle sidebars
            document.getElementById('sidebar-server-content').classList.toggle('hidden', view !== 'server');
            document.getElementById('sidebar-home-content').classList.toggle('hidden', view !== 'home');
            
            // Toggle Header
            document.getElementById('header-channel-name').innerText = (view === 'home') ? 'Friends' : 'general';

            // Update Nav Icons
            document.querySelectorAll('.guild-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');
        },

        renderMembers() {
            const onlineList = document.getElementById('list-online');
            const voiceList = document.getElementById('voice-occupants');
            const stageGrid = document.getElementById('stage-grid');
            
            onlineList.innerHTML = "";
            voiceList.innerHTML = "";
            if(App.State.inVoice) stageGrid.innerHTML = "";

            const allPeers = Object.values(App.State.peers);
            const me = { 
                ...App.State.user, 
                speaking: App.Voice.checkSpeaking(), 
                muted: App.State.isMuted, 
                video: (App.State.cameraActive || App.State.screenActive), 
                room: App.State.activeRoom,
                isMe: true 
            };
            
            const usersToRender = [me, ...allPeers];
            document.getElementById('count-online').innerText = usersToRender.length;

            usersToRender.forEach(u => {
                // Member Sidebar Row
                const row = document.createElement('div');
                row.className = 'member-row';
                const hasAv = u.avatar && u.avatar.startsWith('http');
                const avStyle = hasAv ? `background-image:url(${u.avatar})` : `background-color:var(--brand)`;
                row.innerHTML = `
                    <div class="member-avatar flex-center text-white text-xs font-bold" style="${avStyle}">
                        ${hasAv ? '' : u.name[0].toUpperCase()}
                        <div class="absolute bottom-[-2px] right-[-2px] w-3 h-3 bg-emerald-500 rounded-full border-2 border-[#2b2d31]"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-sm truncate">${u.name}</div>
                        <div class="text-[10px] text-indigo-400">Mesh Participant</div>
                    </div>
                `;
                onlineList.appendChild(row);

                // Voice Occupant in Sidebar
                if(u.room) {
                    const vRow = document.createElement('div');
                    vRow.className = 'flex items-center gap-2 p-1 px-2 rounded hover:bg-white/5 cursor-pointer text-sm text-[#949ba4]';
                    vRow.innerHTML = `
                        <div class="w-6 h-6 rounded-full bg-indigo-600 flex-center text-[10px] text-white ${u.speaking ? 'ring-2 ring-emerald-500' : ''}" style="${avStyle}">
                            ${hasAv ? '' : u.name[0].toUpperCase()}
                        </div>
                        <span class="truncate flex-1">${u.name}</span>
                        <div class="flex gap-1">
                            ${u.muted ? '<i class="fa-solid fa-microphone-slash text-[10px]"></i>' : ''}
                            ${u.video ? '<i class="fa-solid fa-video text-[10px]"></i>' : ''}
                        </div>
                    `;
                    voiceList.appendChild(vRow);

                    // Stage Grid Card
                    if(App.State.inVoice && u.room === App.State.activeRoom) {
                        const card = document.createElement('div');
                        card.className = `peer-card ${u.speaking ? 'speaking' : ''}`;
                        
                        if(u.isMe && u.video && App.State.localStream) {
                            card.innerHTML = `<video class="peer-video" autoplay muted playsinline></video>`;
                            const vid = card.querySelector('video');
                            vid.srcObject = App.State.localStream;
                        } else {
                            card.innerHTML = `<div class="peer-placeholder-av flex-center text-white text-3xl font-bold ${u.speaking ? 'pulse' : ''}" style="${avStyle}">${hasAv ? '' : u.name[0].toUpperCase()}</div>`;
                        }
                        
                        card.innerHTML += `
                            <div class="peer-label flex items-center gap-2">
                                ${u.name}
                                ${u.muted ? '<i class="fa-solid fa-microphone-slash text-xs text-red-500"></i>' : ''}
                            </div>
                        `;
                        stageGrid.appendChild(card);
                    }
                }
            });
        },

        toggleSettings(show) {
            document.getElementById('settings-layer').style.display = show ? 'block' : 'none';
        },

        toggleSearch(show) {
            document.getElementById('search-overlay').style.display = show ? 'flex' : 'none';
            if(show) document.getElementById('search-bar-input').focus();
        },

        closeAllOverlays() {
            this.toggleSettings(false);
            this.toggleSearch(false);
        }
    },

    /* --- AUTH & PROFILE --- */
    Auth: {
        updateIdentityUI() {
            const user = App.State.user;
            document.getElementById('my-u-name').innerText = user.name;
            document.getElementById('my-u-tag').innerText = "#" + user.id;
            
            document.getElementById('settings-name-preview').innerText = user.name;
            document.getElementById('settings-tag-preview').innerText = "#" + user.id;
            document.getElementById('set-username').value = user.name;
            document.getElementById('set-avatar').value = user.avatar;

            const hasAv = user.avatar && user.avatar.startsWith('http');
            const avs = [document.getElementById('my-u-avatar'), document.getElementById('settings-av-preview')];
            
            avs.forEach(el => {
                if(hasAv) {
                    el.style.backgroundImage = `url(${user.avatar})`;
                    el.innerHTML = "";
                } else {
                    el.style.backgroundImage = "none";
                    el.style.backgroundColor = "var(--brand)";
                    el.classList.add('flex-center', 'text-white', 'font-bold');
                    el.innerText = user.name[0].toUpperCase();
                }
            });
        },

        saveProfile() {
            const name = document.getElementById('set-username').value.trim();
            const avatar = document.getElementById('set-avatar').value.trim();
            
            if(name) App.State.user.name = name;
            App.State.user.avatar = avatar;

            localStorage.setItem('dm_name', App.State.user.name);
            localStorage.setItem('dm_av', App.State.user.avatar);

            this.updateIdentityUI();
            App.UI.toggleSettings(false);
            App.Network.broadcastPresence();
        },

        logout() {
            localStorage.clear();
            window.location.reload();
        }
    }
};

// Start Application
window.onload = () => App.init();

</script>
</body>
</html>
