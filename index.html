<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pipboy MQTT Chatroom</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        background: #000;
        color: #00ff66;
        font-family: "Courier New", monospace;
        height: 100%;
        overflow: hidden;
    }

    body {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #pipboy-shell {
        position: relative;
        width: 960px;
        height: 540px;
        background: #000;
    }

    /* Monitor border on/off */
    #monitor-border {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        pointer-events: none;
    }

    /* Screen area */
    #screen {
        position: absolute;
        left: 80px;
        top: 40px;
        right: 80px;
        bottom: 80px;
        background: #001900;
        overflow: hidden;
        color: #00ff66;
        text-shadow: 0 0 4px #00ff66;
    }

    /* BG overlay on */
    #screen-bg-on {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        opacity: 0.25;
        pointer-events: none;
        mix-blend-mode: screen;
    }

    /* Flicker effect */
    @keyframes flicker {
        0% { opacity: 0.9; }
        5% { opacity: 0.7; }
        10% { opacity: 0.95; }
        15% { opacity: 0.6; }
        20% { opacity: 0.9; }
        25% { opacity: 0.8; }
        30% { opacity: 0.95; }
        35% { opacity: 0.7; }
        40% { opacity: 0.9; }
        100% { opacity: 0.9; }
    }

    #screen-inner {
        position: absolute;
        inset: 10px;
        border: 2px solid #00ff66;
        padding: 8px;
        box-sizing: border-box;
        animation: flicker 1.5s infinite;
    }

    .scanline {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(to bottom, rgba(0,255,102,0.3), transparent);
        animation: scan 2s linear infinite;
        pointer-events: none;
    }

    @keyframes scan {
        0% { top: -2px; }
        100% { top: 100%; }
    }

    /* Startup screen */
    #startup-screen {
        position: absolute;
        inset: 0;
        padding: 20px;
        box-sizing: border-box;
        font-size: 16px;
        line-height: 1.4;
        white-space: pre;
    }

    /* Main UI layout */
    #main-ui {
        position: absolute;
        inset: 0;
        display: none;
    }

    #top-bar {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 4px;
    }

    #top-bar .section-title {
        font-weight: bold;
        letter-spacing: 2px;
    }

    #pip-tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 4px;
        font-size: 13px;
    }

    .pip-tab {
        padding: 2px 6px;
        border: 1px solid #00ff66;
        cursor: pointer;
    }

    .pip-tab.active {
        background: #00ff66;
        color: #001900;
    }

    #content-area {
        position: absolute;
        left: 0;
        right: 0;
        top: 40px;
        bottom: 0;
        display: flex;
    }

    #left-menu {
        width: 140px;
        border-right: 1px solid #00ff66;
        padding-right: 4px;
        box-sizing: border-box;
        font-size: 13px;
    }

    .left-menu-item {
        padding: 2px 2px;
        cursor: pointer;
    }

    .left-menu-item.selected {
        background: #00ff66;
        color: #001900;
    }

    #main-panel {
        flex: 1;
        padding-left: 6px;
        box-sizing: border-box;
        font-size: 13px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .panel {
        display: none;
        flex: 1;
        overflow: hidden;
    }

    .panel.active {
        display: flex;
        flex-direction: column;
    }

    /* Chatroom panel */
    #chat-tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 2px;
    }

    .chat-tab {
        padding: 1px 4px;
        border: 1px solid #00ff66;
        cursor: pointer;
        font-size: 12px;
    }

    .chat-tab.active {
        background: #00ff66;
        color: #001900;
    }

    #chat-view {
        flex: 1;
        border: 1px solid #00ff66;
        padding: 2px;
        box-sizing: border-box;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    #chat-input-row {
        display: flex;
        margin-top: 2px;
    }

    #chat-input {
        flex: 1;
        background: transparent;
        border: 1px solid #00ff66;
        color: #00ff66;
        font-family: inherit;
        font-size: 13px;
        padding: 2px;
        outline: none;
    }

    #chat-send {
        margin-left: 4px;
        padding: 2px 8px;
        border: 1px solid #00ff66;
        background: transparent;
        color: #00ff66;
        cursor: pointer;
        font-size: 13px;
    }

    /* Lists */
    .list-view {
        flex: 1;
        border: 1px solid #00ff66;
        padding: 2px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    .list-item {
        padding: 1px 2px;
    }

    .list-item.selected {
        background: #00ff66;
        color: #001900;
    }

    /* Settings */
    #settings-form label {
        display: block;
        margin-bottom: 4px;
    }

    #settings-form input {
        background: transparent;
        border: 1px solid #00ff66;
        color: #00ff66;
        font-family: inherit;
        font-size: 13px;
        padding: 2px;
        outline: none;
        width: 200px;
    }

    #settings-form button {
        margin-top: 4px;
        padding: 2px 8px;
        border: 1px solid #00ff66;
        background: transparent;
        color: #00ff66;
        cursor: pointer;
        font-size: 13px;
    }

    /* Terminal / card selection */
    #terminal-panel {
        font-size: 13px;
    }

    #card-list {
        margin-top: 2px;
    }

    .card-item {
        padding: 1px 2px;
    }

    .card-item.selected {
        background: #00ff66;
        color: #001900;
    }

    /* Simple “off” overlay */
    #power-off-overlay {
        position: absolute;
        inset: 0;
        background: #000;
        display: none;
    }

    /* Small HUD text */
    .hud-line {
        font-size: 11px;
    }

    /* Scrollbar styling (optional) */
    ::-webkit-scrollbar {
        width: 6px;
    }
    ::-webkit-scrollbar-track {
        background: #001900;
    }
    ::-webkit-scrollbar-thumb {
        background: #00ff66;
    }
</style>
</head>
<body>
<div id="pipboy-shell">
    <div id="monitor-border"></div>
    <div id="screen">
        <div id="screen-bg-on"></div>
        <div id="screen-inner">
            <div class="scanline"></div>

            <!-- STARTUP SCREEN -->
            <div id="startup-screen">
*****PIP-OS(R) V7.1.0.8*****
COPYRIGHT 2075 ROBCO(R)
LOADER V1.1
EXEC VERSION 41.10
64k RAM SYSTEM
38911 BYTES FREE
NO HOLOTAPE FOUND
LOAD ROM(1): DEITRIX 303
            </div>

            <!-- MAIN UI -->
            <div id="main-ui">
                <div id="top-bar">
                    <div class="section-title">PIP-BOY 3000 MK IV</div>
                    <div>STATUS: <span id="mqtt-status">DISCONNECTED</span></div>
                </div>

                <div id="pip-tabs">
                    <div class="pip-tab active" data-tab="status">STATUS</div>
                    <div class="pip-tab" data-tab="special">CHARACTER</div>
                    <div class="pip-tab" data-tab="items">ITEMS</div>
                    <div class="pip-tab" data-tab="map">MAP</div>
                    <div class="pip-tab" data-tab="radio">TERMINAL</div>
                    <div class="pip-tab" data-tab="chat">CHATROOM</div>
                </div>

                <div id="content-area">
                    <div id="left-menu">
                        <div class="left-menu-item selected" data-menu="health">Health</div>
                        <div class="left-menu-item" data-menu="stats">Stats</div>
                        <div class="left-menu-item" data-menu="effects">Effects</div>
                        <div class="left-menu-item" data-menu="perk">Perks</div>
                        <div class="left-menu-item" data-menu="misc">Misc</div>
                    </div>

                    <div id="main-panel">
                        <!-- STATUS PANEL -->
                        <div class="panel active" data-panel="status">
                            <div class="hud-line">HP: 100/100   AP: 100/100   RAD: 0</div>
                            <div class="hud-line">LVL: 1   XP: 0/100</div>
                            <div style="margin-top:8px;">Vault-Tec Assisted Targeting System (V.A.T.S.) not available in this build.</div>
                        </div>

                        <!-- CHARACTER PANEL -->
                        <div class="panel" data-panel="special">
                            <div>CHARACTER</div>
                            <div style="margin-top:4px;">
                                S.P.E.C.I.A.L. overview not implemented—this is your chat-focused Pip-Boy build.
                            </div>
                        </div>

                        <!-- ITEMS PANEL -->
                        <div class="panel" data-panel="items">
                            <div>ITEMS</div>
                            <div style="margin-top:4px;">
                                Inventory placeholder. Imagine Stimpaks, Fancy Lads Snack Cakes, and a very overworked Pip-Boy.
                            </div>
                        </div>

                        <!-- MAP PANEL -->
                        <div class="panel" data-panel="map">
                            <div>MAP</div>
                            <div style="margin-top:4px;">
                                Map system placeholder. Future hook for a world map or server browser.
                            </div>
                        </div>

                        <!-- TERMINAL PANEL (CARD SELECT) -->
                        <div class="panel" data-panel="radio" id="terminal-panel">
                            <div>ROBCO INDUSTRIES (TM) TERMLINK PROTOCOL</div>
                            <div>SELECT A CARD:</div>
                            <div id="card-list">
                                <div class="card-item selected" data-card="chatroom">[CHATROOM]</div>
                            </div>
                            <div style="margin-top:4px;">
                                Use ↑/↓ to select a card, ENTER to load.
                            </div>
                        </div>

                        <!-- CHATROOM PANEL -->
                        <div class="panel" data-panel="chat" id="chat-panel">
                            <div id="chat-tabs">
                                <div class="chat-tab active" data-chat-tab="main">Main Chatroom</div>
                                <div class="chat-tab" data-chat-tab="active">Active Users</div>
                                <div class="chat-tab" data-chat-tab="friends">Friends</div>
                                <div class="chat-tab" data-chat-tab="requests">Friend Requests</div>
                                <div class="chat-tab" data-chat-tab="settings">Settings</div>
                            </div>

                            <!-- MAIN CHATROOM VIEW -->
                            <div class="panel active" data-chat-panel="main">
                                <div id="chat-view"></div>
                                <div id="chat-input-row">
                                    <input id="chat-input" type="text" placeholder="Type message (prefix ]\ for admin command)..." />
                                    <button id="chat-send">SEND</button>
                                </div>
                            </div>

                            <!-- ACTIVE USERS VIEW -->
                            <div class="panel" data-chat-panel="active">
                                <div class="list-view" id="active-users-list"></div>
                            </div>

                            <!-- FRIENDS VIEW -->
                            <div class="panel" data-chat-panel="friends">
                                <div class="list-view" id="friends-list"></div>
                            </div>

                            <!-- FRIEND REQUESTS VIEW -->
                            <div class="panel" data-chat-panel="requests">
                                <div class="list-view" id="friend-requests-list"></div>
                            </div>

                            <!-- SETTINGS VIEW -->
                            <div class="panel" data-chat-panel="settings">
                                <div id="settings-form">
                                    <label>
                                        Username:
                                        <input type="text" id="username-input" placeholder="Enter username" />
                                    </label>
                                    <button id="save-username">Set Username</button>
                                    <div style="margin-top:6px;">
                                        Friend a user: type their name in chat as <code>/friend username</code>.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- main-panel -->
                </div> <!-- content-area -->
            </div> <!-- main-ui -->
        </div> <!-- screen-inner -->
    </div> <!-- screen -->

    <div id="power-off-overlay"></div>
</div>

<!-- MQTT.js from CDN -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
(function() {
    // ---------- BASIC VISUAL SETUP ----------
    const monitorBorder = document.getElementById('monitor-border');
    const screenBgOn = document.getElementById('screen-bg-on');
    const powerOffOverlay = document.getElementById('power-off-overlay');
    const startupScreen = document.getElementById('startup-screen');
    const mainUI = document.getElementById('main-ui');
    const mqttStatusEl = document.getElementById('mqtt-status');

    // Images
    const IMG_MONITOR_ON = 'assets/monitorborder.png';
    const IMG_MONITOR_OFF = 'assets/monitorborder-off.png';
    const IMG_BG_ON = '/assets/bg-on.png';
    const IMG_BG_OFF = '/assets/bg-off.png';

    function setPower(on) {
        if (on) {
            monitorBorder.style.backgroundImage = 'url(' + IMG_MONITOR_ON + ')';
            screenBgOn.style.backgroundImage = 'url(' + IMG_BG_ON + ')';
            powerOffOverlay.style.display = 'none';
        } else {
            monitorBorder.style.backgroundImage = 'url(' + IMG_MONITOR_OFF + ')';
            screenBgOn.style.backgroundImage = 'url(' + IMG_BG_OFF + ')';
            powerOffOverlay.style.display = 'block';
        }
    }

    setPower(true);

    // Startup sequence
    setTimeout(() => {
        startupScreen.style.display = 'none';
        mainUI.style.display = 'block';
    }, 3500);

    // ---------- TAB / PANEL LOGIC ----------
    const pipTabs = document.querySelectorAll('.pip-tab');
    const panels = document.querySelectorAll('.panel[data-panel]');
    pipTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.getAttribute('data-tab');
            pipTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            panels.forEach(p => {
                if (p.getAttribute('data-panel') === target) {
                    p.classList.add('active');
                } else {
                    p.classList.remove('active');
                }
            });
        });
    });

    // Left menu (cosmetic)
    const leftMenuItems = document.querySelectorAll('.left-menu-item');
    let leftMenuIndex = 0;
    function updateLeftMenuSelection() {
        leftMenuItems.forEach((item, idx) => {
            item.classList.toggle('selected', idx === leftMenuIndex);
        });
    }
    leftMenuItems.forEach((item, idx) => {
        item.addEventListener('click', () => {
            leftMenuIndex = idx;
            updateLeftMenuSelection();
        });
    });

    // Terminal card selection
    const cardItems = document.querySelectorAll('.card-item');
    let cardIndex = 0;
    function updateCardSelection() {
        cardItems.forEach((item, idx) => {
            item.classList.toggle('selected', idx === cardIndex);
        });
    }

    function openSelectedCard() {
        const card = cardItems[cardIndex].getAttribute('data-card');
        if (card === 'chatroom') {
            // Switch to CHATROOM tab
            pipTabs.forEach(t => {
                if (t.getAttribute('data-tab') === 'chat') {
                    t.click();
                }
            });
        }
    }

    // Chat tabs
    const chatTabs = document.querySelectorAll('.chat-tab');
    const chatPanels = document.querySelectorAll('.panel[data-chat-panel]');
    let chatTabIndex = 0;
    function setChatTabByIndex(idx) {
        chatTabIndex = idx;
        chatTabs.forEach((t, i) => {
            t.classList.toggle('active', i === idx);
        });
        const target = chatTabs[idx].getAttribute('data-chat-tab');
        chatPanels.forEach(p => {
            p.classList.toggle('active', p.getAttribute('data-chat-panel') === target);
        });
    }
    chatTabs.forEach((tab, idx) => {
        tab.addEventListener('click', () => setChatTabByIndex(idx));
    });

    // ---------- CHAT / FRIENDS STATE ----------
    const chatView = document.getElementById('chat-view');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const activeUsersList = document.getElementById('active-users-list');
    const friendsList = document.getElementById('friends-list');
    const friendRequestsList = document.getElementById('friend-requests-list');
    const usernameInput = document.getElementById('username-input');
    const saveUsernameBtn = document.getElementById('save-username');

    let username = 'VaultDweller' + Math.floor(Math.random() * 1000);
    usernameInput.value = username;

    let activeUsers = new Set();
    let friends = []; // array of {a,b}
    let friendRequests = []; // array of {from,to,raw}

    function logChat(line) {
        const atBottom = chatView.scrollTop + chatView.clientHeight >= chatView.scrollHeight - 5;
        chatView.textContent += line + '\n';
        if (atBottom) {
            chatView.scrollTop = chatView.scrollHeight;
        }
    }

    function renderActiveUsers() {
        activeUsersList.innerHTML = '';
        Array.from(activeUsers).sort().forEach(u => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = u;
            activeUsersList.appendChild(div);
        });
    }

    function renderFriends() {
        friendsList.innerHTML = '';
        friends.forEach(pair => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = pair.a + ' ↔ ' + pair.b;
            friendsList.appendChild(div);
        });
    }

    function renderFriendRequests() {
        friendRequestsList.innerHTML = '';
        friendRequests.forEach((req, idx) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = req.raw + '  [ENTER to accept if selected]';
            div.dataset.index = idx;
            friendRequestsList.appendChild(div);
        });
    }

    // ---------- MQTT SETUP ----------
    const MQTT_BROKER_URL = 'wss://mqtt.flespi.io:443';
    const MQTT_TOKEN = 'g977bmKI5b1CdmpybeBxi4QfXcrGVva0oUvZc4mb9lhxNkIL3L2pXhIfhI7NP2J0';

    const TOPIC_PUBLIC = 'pipboy/publicmessages/public';
    const TOPIC_COMMANDS = 'pipboy/publicmessages/commands';
    const TOPIC_FRIEND_REQUEST = 'pipboy/system/pineapple/friendrequest';
    const TOPIC_FRIENDS = 'pipboy/system/applesauce/friends';
    const TOPIC_PRESENCE = 'pipboy/system/presence';

    let client = null;

    function connectMQTT() {
        const clientId = 'pipboy-' + Math.random().toString(16).substr(2, 8);
        client = mqtt.connect(MQTT_BROKER_URL, {
            clientId: clientId,
            username: MQTT_TOKEN,
            password: '',
            clean: true,
            reconnectPeriod: 3000
        });

        client.on('connect', () => {
            mqttStatusEl.textContent = 'CONNECTED';
            mqttStatusEl.style.color = '#00ff66';
            client.subscribe([TOPIC_PUBLIC, TOPIC_COMMANDS, TOPIC_FRIEND_REQUEST, TOPIC_FRIENDS, TOPIC_PRESENCE]);
            // announce presence
            publishPresence('online');
        });

        client.on('reconnect', () => {
            mqttStatusEl.textContent = 'RECONNECTING';
            mqttStatusEl.style.color = '#ffff00';
        });

        client.on('close', () => {
            mqttStatusEl.textContent = 'DISCONNECTED';
            mqttStatusEl.style.color = '#ff0000';
        });

        client.on('message', (topic, payload) => {
            const msg = payload.toString();
            if (topic === TOPIC_PUBLIC) {
                logChat(msg);
            } else if (topic === TOPIC_COMMANDS) {
                handleCommandMessage(msg);
            } else if (topic === TOPIC_FRIEND_REQUEST) {
                handleFriendRequestMessage(msg);
            } else if (topic === TOPIC_FRIENDS) {
                handleFriendsMessage(msg);
            } else if (topic === TOPIC_PRESENCE) {
                handlePresenceMessage(msg);
            } else if (topic.startsWith('pipboy/directmessage/Chat')) {
                logChat('[DM] ' + msg);
            }
        });
    }

    function publish(topic, message) {
        if (client && client.connected) {
            client.publish(topic, message);
        }
    }

    function publishPresence(state) {
        const msg = 'u="' + username + '" presence="' + state + '"';
        publish(TOPIC_PRESENCE, msg);
    }

    // ---------- PUBLIC CHAT / COMMANDS ----------
    function sendChatMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        chatInput.value = '';

        if (text.startsWith(']/')) {
            // admin command: publish to commands topic
            const cmd = text.substring(2).trim();
            const msg = 'u="' + username + '" cmd="' + cmd + '"';
            publish(TOPIC_COMMANDS, msg);
            logChat('[CMD SENT] ' + msg);
        } else if (text.startsWith('/friend ')) {
            const target = text.substring(8).trim();
            if (target) {
                const msg = 'u="' + username + '" attempent to add u="' + target + '"';
                publish(TOPIC_FRIEND_REQUEST, msg);
                logChat('[FRIEND REQUEST SENT] ' + msg);
            }
        } else if (text.startsWith('/dm ')) {
            const parts = text.split(' ');
            if (parts.length >= 3) {
                const target = parts[1];
                const dmText = parts.slice(2).join(' ');
                const chatId = Math.floor(100000 + Math.random() * 900000);
                const topic = 'pipboy/directmessage/Chat' + chatId;
                const msg = '[DM ' + username + ' -> ' + target + '] ' + dmText;
                publish(topic, msg);
                logChat(msg);
            }
        } else {
            const msg = username + ': ' + text;
            publish(TOPIC_PUBLIC, msg);
        }
    }

    chatSend.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });

    // Handle commands from /commands topic
    function handleCommandMessage(msg) {
        // Expected format: u="username" cmd="aboutblank" etc.
        // Very simple parse:
        const cmdMatch = msg.match(/cmd="([^"]+)"/);
        if (!cmdMatch) return;
        const cmd = cmdMatch[1];

        if (cmd === 'aboutblank') {
            // Kick everyone: blank screen
            document.location.href = 'about:blank';
        } else if (cmd.startsWith('kick ')) {
            const target = cmd.substring(5).trim();
            if (target === 'everyone') {
                document.location.href = 'about:blank';
            } else {
                // Kick specific user
                if (target === username) {
                    document.location.href = 'about:blank';
                }
            }
        } else if (cmd === 'service') {
            window.location.href = '/service.html';
        } else if (cmd === 'reload') {
            window.location.reload();
        }
    }

    // ---------- FRIEND SYSTEM ----------
    function handleFriendRequestMessage(msg) {
        // Format: u="username" attempent to add u="otherusername"
        const fromMatch = msg.match(/u="([^"]+)"/);
        const toMatch = msg.match(/add u="([^"]+)"/);
        if (!fromMatch || !toMatch) return;
        const from = fromMatch[1];
        const to = toMatch[1];

        if (to === username) {
            friendRequests.push({ from, to, raw: msg });
            renderFriendRequests();
        }
    }

    function handleFriendsMessage(msg) {
        // Format: "1st user" "2nd user"
        const m = msg.match(/"([^"]+)"\s+"([^"]+)"/);
        if (!m) return;
        const a = m[1];
        const b = m[2];

        // Avoid duplicates
        if (!friends.some(p => (p.a === a && p.b === b) || (p.a === b && p.b === a))) {
            friends.push({ a, b });
            renderFriends();
        }
    }

    function acceptFriendRequest(index) {
        const req = friendRequests[index];
        if (!req) return;
        const msg = 'u="' + req.to + '" Accepted u="' + req.from + '"\'s Friend Request';
        publish(TOPIC_FRIEND_REQUEST, msg);
        // Also publish to friends topic
        const pairMsg = '"' + req.to + '" "' + req.from + '"';
        publish(TOPIC_FRIENDS, pairMsg);
        friendRequests.splice(index, 1);
        renderFriendRequests();
    }

    // Presence
    function handlePresenceMessage(msg) {
        // Format: u="username" presence="online/offline"
        const uMatch = msg.match(/u="([^"]+)"/);
        const sMatch = msg.match(/presence="([^"]+)"/);
        if (!uMatch || !sMatch) return;
        const u = uMatch[1];
        const s = sMatch[1];
        if (s === 'online') {
            activeUsers.add(u);
        } else {
            activeUsers.delete(u);
        }
        renderActiveUsers();
    }

    // ---------- SETTINGS ----------
    saveUsernameBtn.addEventListener('click', () => {
        const newName = usernameInput.value.trim();
        if (!newName) return;
        // announce offline for old name
        publishPresence('offline');
        username = newName;
        publishPresence('online');
        logChat('[SYSTEM] Username set to ' + username);
    });

    // ---------- KEYBOARD NAVIGATION ----------
    document.addEventListener('keydown', (e) => {
        const activePanel = document.querySelector('.panel[data-panel].active');
        const activePanelName = activePanel ? activePanel.getAttribute('data-panel') : '';

        if (activePanelName === 'radio') {
            // Terminal card selection
            if (e.key === 'ArrowUp') {
                cardIndex = (cardIndex - 1 + cardItems.length) % cardItems.length;
                updateCardSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                cardIndex = (cardIndex + 1) % cardItems.length;
                updateCardSelection();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                openSelectedCard();
                e.preventDefault();
            }
        } else if (activePanelName === 'chat') {
            // Chatroom navigation
            if (e.key === 'ArrowLeft') {
                setChatTabByIndex((chatTabIndex - 1 + chatTabs.length) % chatTabs.length);
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                setChatTabByIndex((chatTabIndex + 1) % chatTabs.length);
                e.preventDefault();
            } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'Enter') {
                // Friend requests accept via keyboard when in Friend Requests tab
                const currentTab = chatTabs[chatTabIndex].getAttribute('data-chat-tab');
                if (currentTab === 'requests') {
                    const items = friendRequestsList.querySelectorAll('.list-item');
                    if (items.length > 0) {
                        // simple single-selection cycling
                        let selIndex = -1;
                        items.forEach((it, idx) => {
                            if (it.classList.contains('selected')) selIndex = idx;
                        });
                        if (selIndex === -1) selIndex = 0;
                        if (e.key === 'ArrowUp') {
                            selIndex = (selIndex - 1 + items.length) % items.length;
                        } else if (e.key === 'ArrowDown') {
                            selIndex = (selIndex + 1) % items.length;
                        } else if (e.key === 'Enter') {
                            acceptFriendRequest(selIndex);
                        }
                        items.forEach((it, idx) => {
                            it.classList.toggle('selected', idx === selIndex);
                        });
                        e.preventDefault();
                    }
                }
            }
        } else {
            // Left menu navigation
            if (e.key === 'ArrowUp') {
                leftMenuIndex = (leftMenuIndex - 1 + leftMenuItems.length) % leftMenuItems.length;
                updateLeftMenuSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                leftMenuIndex = (leftMenuIndex + 1) % leftMenuItems.length;
                updateLeftMenuSelection();
                e.preventDefault();
            }
        }
    });

    // ---------- WINDOW LIFECYCLE ----------
    window.addEventListener('beforeunload', () => {
        publishPresence('offline');
    });

    // Connect MQTT after a short delay (let UI come up)
    setTimeout(connectMQTT, 1000);
})();
</script>
</body>
</html>
