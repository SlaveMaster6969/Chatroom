<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pip‑Boy 3000 Mk IV – MQTT Chatroom (Fullscreen)</title>
<style>
/* ====== GLOBAL ====== */
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    font-family: "Courier New", monospace;
    color: #00ff66;
}

/* Fullscreen CRT screen */
#screen {
    position: fixed;
    inset: 0;
    background: #001900;
    color: #00ff66;
    text-shadow: 0 0 8px #00ff66;
    overflow: hidden;
}

/* CRT curvature + glow */
#screen::before {
    content: "";
    position: absolute;
    inset: -20%;
    background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,0.12), transparent 60%),
        radial-gradient(circle at 0% 50%, rgba(255,255,255,0.06), transparent 55%),
        radial-gradient(circle at 100% 50%, rgba(255,255,255,0.06), transparent 55%);
    mix-blend-mode: screen;
    pointer-events: none;
}

/* Scanline */
.scanline {
    position: absolute;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(to bottom, rgba(0,255,102,0.4), transparent);
    animation: scan 2.5s linear infinite;
    pointer-events: none;
}
@keyframes scan {
    0% { top: -3px; }
    100% { top: 100%; }
}

/* Text sizes (big UI) */
.big   { font-size: 32px; }
.med   { font-size: 24px; }
.small { font-size: 18px; }

/* ====== LAYOUT ====== */
#top-bar {
    display: flex;
    justify-content: space-between;
    padding: 10px 20px;
    font-size: 26px;
}

#tabs {
    display: flex;
    gap: 10px;
    padding: 10px 20px;
    font-size: 26px;
}

.tab {
    padding: 6px 16px;
    border: 2px solid #00ff66;
    cursor: pointer;
    transition: background 0.12s, color 0.12s, transform 0.08s;
}
.tab:hover {
    transform: translateY(-1px);
}
.tab.active {
    background: #00ff66;
    color: #001900;
    text-shadow: none;
}

/* Panels */
.panel {
    display: none;
    padding: 20px;
    height: calc(100% - 140px);
    overflow-y: auto;
}
.panel.active {
    display: block;
}

/* STAT panel */
#stat-panel {
    display: grid;
    grid-template-columns: 1.2fr 1.8fr;
    gap: 20px;
}
#stat-left {
    border-right: 2px solid #00ff66;
    padding-right: 20px;
}
#stat-right {
    padding-left: 10px;
}
.stat-bar {
    margin-bottom: 12px;
}
.stat-bar-label {
    font-size: 22px;
    margin-bottom: 4px;
}
.stat-bar-track {
    width: 100%;
    height: 18px;
    border: 2px solid #00ff66;
    box-sizing: border-box;
    position: relative;
}
.stat-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background: #00ff66;
}

/* Inventory */
.inv-category-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.inv-category {
    padding: 4px 12px;
    border: 2px solid #00ff66;
    cursor: pointer;
    font-size: 22px;
}
.inv-category.active {
    background: #00ff66;
    color: #001900;
}
#inv-layout {
    display: grid;
    grid-template-columns: 1.4fr 1.6fr;
    gap: 20px;
}
#inv-list {
    border: 2px solid #00ff66;
    padding: 10px;
    max-height: 60vh;
    overflow-y: auto;
}
.inv-item {
    padding: 6px;
    border-bottom: 1px solid #00ff66;
    font-size: 24px;
    cursor: pointer;
}
.inv-item.selected {
    background: #00ff66;
    color: #001900;
}
#inv-desc {
    border: 2px solid #00ff66;
    padding: 10px;
    font-size: 22px;
    white-space: pre-wrap;
}

/* DATA */
#data-list {
    border: 2px solid #00ff66;
    padding: 10px;
    font-size: 24px;
}

/* MAP */
#map-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(8, 1fr);
    gap: 2px;
    border: 2px solid #00ff66;
    padding: 4px;
    height: 60vh;
}
.map-cell {
    border: 1px solid #003300;
    background: #001500;
}

/* RADIO */
#radio-list {
    border: 2px solid #00ff66;
    padding: 10px;
    font-size: 24px;
}
.radio-item {
    padding: 6px;
    border-bottom: 1px solid #00ff66;
    cursor: pointer;
}
.radio-item.selected {
    background: #00ff66;
    color: #001900;
}
#radio-info {
    margin-top: 10px;
    border: 2px solid #00ff66;
    padding: 10px;
    font-size: 22px;
}

/* TERMINAL */
#terminal-panel button {
    font-size: 28px;
    padding: 16px 30px;
    border: 2px solid #00ff66;
    background: transparent;
    color: #00ff66;
    cursor: pointer;
}

/* CHAT */
#chat-layout {
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: 10px;
    height: 100%;
}
#chat-tabs {
    display: flex;
    gap: 10px;
}
.chat-tab {
    padding: 4px 12px;
    border: 2px solid #00ff66;
    cursor: pointer;
    font-size: 22px;
}
.chat-tab.active {
    background: #00ff66;
    color: #001900;
}
.chat-subpanel {
    display: none;
}
.chat-subpanel.active {
    display: block;
}
#chat-view {
    border: 2px solid #00ff66;
    padding: 10px;
    height: 50vh;
    overflow-y: auto;
    font-size: 22px;
    white-space: pre-wrap;
}
#chat-input-row {
    display: flex;
    gap: 10px;
}
#chat-input {
    flex: 1;
    font-size: 24px;
    padding: 10px;
    background: transparent;
    border: 2px solid #00ff66;
    color: #00ff66;
}
#chat-send {
    font-size: 24px;
    padding: 10px 20px;
    border: 2px solid #00ff66;
    background: transparent;
    color: #00ff66;
    cursor: pointer;
}

/* Lists */
.list-box {
    border: 2px solid #00ff66;
    padding: 10px;
    height: 50vh;
    overflow-y: auto;
    font-size: 22px;
}
.list-item {
    padding: 6px;
    border-bottom: 1px solid #00ff66;
}

/* Settings */
#settings-form label {
    display: block;
    margin-bottom: 10px;
    font-size: 22px;
}
#settings-form input {
    font-size: 24px;
    padding: 8px;
    background: transparent;
    border: 2px solid #00ff66;
    color: #00ff66;
    width: 320px;
}
#settings-form button {
    font-size: 24px;
    padding: 8px 16px;
    border: 2px solid #00ff66;
    background: transparent;
    color: #00ff66;
    cursor: pointer;
}

/* Terminal Card Overlay */
#terminal-card {
    position: fixed;
    inset: 0;
    background: #001900;
    display: none;
    padding: 40px;
    box-sizing: border-box;
}
#terminal-card-title {
    font-size: 32px;
    margin-bottom: 20px;
}
.card-option {
    padding: 12px;
    border: 2px solid #00ff66;
    margin-bottom: 20px;
    font-size: 28px;
    cursor: pointer;
}
.card-option:hover {
    background: #00ff66;
    color: #001900;
}

/* Scrollbars */
::-webkit-scrollbar {
    width: 8px;
}
::-webkit-scrollbar-track {
    background: #001900;
}
::-webkit-scrollbar-thumb {
    background: #00ff66;
}
</style>
</head>
<body>
<div id="screen">
    <div class="scanline"></div>

    <!-- TOP BAR -->
    <div id="top-bar">
        <div>PIP-BOY 3000 MK IV</div>
        <div>STATUS: <span id="mqtt-status">DISCONNECTED</span></div>
    </div>

    <!-- MAIN TABS -->
    <div id="tabs">
        <div class="tab active" data-panel="stat">STAT</div>
        <div class="tab" data-panel="inv">INV</div>
        <div class="tab" data-panel="data">DATA</div>
        <div class="tab" data-panel="map">MAP</div>
        <div class="tab" data-panel="radio">RADIO</div>
        <div class="tab" data-panel="terminal">TERMINAL</div>
        <div class="tab" data-panel="chat">CHAT</div>
    </div>

    <!-- PANELS -->
    <!-- STAT -->
    <div id="stat" class="panel active">
        <div id="stat-panel">
            <div id="stat-left" class="big">
                HP: <span id="stat-hp">100</span>/100<br>
                AP: <span id="stat-ap">100</span>/100<br>
                RAD: <span id="stat-rad">0</span><br><br>
                LEVEL: <span id="stat-lvl">1</span><br>
                XP: <span id="stat-xp">0</span>/100
            </div>
            <div id="stat-right">
                <div class="stat-bar">
                    <div class="stat-bar-label">HP</div>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" id="bar-hp" style="width:100%;"></div>
                    </div>
                </div>
                <div class="stat-bar">
                    <div class="stat-bar-label">AP</div>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" id="bar-ap" style="width:100%;"></div>
                    </div>
                </div>
                <div class="stat-bar">
                    <div class="stat-bar-label">RADS</div>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" id="bar-rad" style="width:0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INV -->
    <div id="inv" class="panel">
        <div class="inv-category-row">
            <div class="inv-category active" data-cat="ALL">ALL</div>
            <div class="inv-category" data-cat="WEAPONS">WEAPONS</div>
            <div class="inv-category" data-cat="AID">AID</div>
            <div class="inv-category" data-cat="MISC">MISC</div>
        </div>
        <div id="inv-layout">
            <div id="inv-list"></div>
            <div id="inv-desc" class="med"></div>
        </div>
    </div>

    <!-- DATA -->
    <div id="data" class="panel">
        <div id="data-list">
            • Out of Time – Leave Vault 111.<br>
            • Jewel of the Commonwealth – Find Nick Valentine.<br>
            • Unlikely Valentine – Rescue Nick from Park Street Station.<br>
            • MQTT: Establish Connection – Connect to the Pip-Boy network.<br>
            • MQTT: Sync Friends – Keep your friends list persistent.<br>
            • MQTT: Secure the Chatroom – Maintain order in the wasteland chatter.<br>
        </div>
    </div>

    <!-- MAP -->
    <div id="map" class="panel">
        <div id="map-grid">
            <!-- 12x8 grid -->
            <!-- Just cells, no placeholders text -->
            <!-- 96 cells -->
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
            <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
        </div>
    </div>

    <!-- RADIO -->
    <div id="radio" class="panel">
        <div id="radio-list">
            <div class="radio-item selected" data-station="diamond">Diamond City Radio</div>
            <div class="radio-item" data-station="classical">Classical Radio</div>
            <div class="radio-item" data-station="terminal">Terminal Tower</div>
        </div>
        <div id="radio-info" class="med" style="margin-top:10px;">
            Diamond City Radio – The best (and only) tunes in the Commonwealth.
        </div>
    </div>

    <!-- TERMINAL -->
    <div id="terminal" class="panel" >
        <div id="terminal-panel" class="big">
            <button id="open-terminal-card">OPEN TERMINAL</button>
        </div>
    </div>

    <!-- CHAT -->
    <div id="chat" class="panel">
        <div id="chat-layout">
            <div id="chat-tabs">
                <div class="chat-tab active" data-chat-panel="main">Main Chatroom</div>
                <div class="chat-tab" data-chat-panel="active">Active Users</div>
                <div class="chat-tab" data-chat-panel="friends">Friends</div>
                <div class="chat-tab" data-chat-panel="requests">Friend Requests</div>
                <div class="chat-tab" data-chat-panel="settings">Settings</div>
            </div>

            <!-- SUBPANELS -->
            <div id="chat-main" class="chat-subpanel active">
                <div id="chat-view"></div>
            </div>

            <div id="chat-active" class="chat-subpanel">
                <div class="list-box" id="active-users-list"></div>
            </div>

            <div id="chat-friends" class="chat-subpanel">
                <div class="list-box" id="friends-list"></div>
            </div>

            <div id="chat-requests" class="chat-subpanel">
                <div class="list-box" id="friend-requests-list"></div>
            </div>

            <div id="chat-settings" class="chat-subpanel">
                <div id="settings-form">
                    <label>
                        Username:
                        <input type="text" id="username-input" placeholder="Enter username">
                    </label>
                    <button id="save-username">Set Username</button>
                    <div style="margin-top:10px;font-size:20px;">
                        Friend someone: type <code>/friend username</code> in chat.<br>
                        Direct message: <code>/dm username message...</code><br>
                        Admin commands are hidden and not shown in chat.
                    </div>
                </div>
            </div>

            <!-- INPUT -->
            <div id="chat-input-row">
                <input id="chat-input" placeholder="Type message...">
                <button id="chat-send">SEND</button>
            </div>
        </div>
    </div>
</div>

<!-- TERMINAL CARD OVERLAY -->
<div id="terminal-card">
    <div id="terminal-card-title">ROBCO INDUSTRIES TERMLINK</div>
    <div class="card-option" data-card="chatroom">TERMINAL CHATROOM</div>
    <div class="card-option" data-card="exit">EXIT</div>
</div>

<!-- MQTT -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
/* ====== BASIC UI STATE ====== */
const tabs = document.querySelectorAll('.tab');
const panels = document.querySelectorAll('.panel');

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const target = tab.dataset.panel;
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        panels.forEach(p => p.classList.remove('active'));
        document.getElementById(target).classList.add('active');
    });
});

/* ====== STAT FUNCTIONS (just to have more functions) ====== */
let statHP = 100;
let statAP = 100;
let statRAD = 0;
let statLVL = 1;
let statXP = 0;

function updateStatUI() {
    document.getElementById('stat-hp').textContent = statHP;
    document.getElementById('stat-ap').textContent = statAP;
    document.getElementById('stat-rad').textContent = statRAD;
    document.getElementById('stat-lvl').textContent = statLVL;
    document.getElementById('stat-xp').textContent = statXP;
    document.getElementById('bar-hp').style.width = statHP + '%';
    document.getElementById('bar-ap').style.width = statAP + '%';
    document.getElementById('bar-rad').style.width = statRAD + '%';
}
function addXP(amount) {
    statXP += amount;
    if (statXP >= 100) {
        statXP -= 100;
        statLVL++;
    }
    updateStatUI();
}
function takeDamage(amount) {
    statHP = Math.max(0, statHP - amount);
    updateStatUI();
}
function heal(amount) {
    statHP = Math.min(100, statHP + amount);
    updateStatUI();
}
updateStatUI();

/* ====== INVENTORY ====== */
const invListEl = document.getElementById('inv-list');
const invDescEl = document.getElementById('inv-desc');
const invCategories = document.querySelectorAll('.inv-category');

const inventory = {
    WEAPONS: [
        {
            name: '10mm Pistol',
            desc: 'Standard issue sidearm. Reliable and accurate.',
            stats: 'DAM 18 | Fire Rate 46 | Range 83 | ACC 60 | Weight 3.5 | Value 50'
        },
        {
            name: 'Laser Musket',
            desc: 'Crank-powered laser rifle favored by the Minutemen.',
            stats: 'DAM 30 | Fire Rate 6 | Range 71 | ACC 69 | Weight 7.0 | Value 75'
        }
    ],
    AID: [
        {
            name: 'Stimpak',
            desc: 'Restores a large amount of health over time.',
            stats: 'Heals 30% HP | Weight 0.1 | Value 50'
        },
        {
            name: 'RadAway',
            desc: 'Flushes radiation from the bloodstream.',
            stats: '-150 RADS | Weight 0.1 | Value 80'
        }
    ],
    MISC: [
        {
            name: 'Pip-Boy Diagnostic Holotape',
            desc: 'Used to test Pip-Boy subsystems.',
            stats: 'Weight 0 | Value 0'
        },
        {
            name: 'Terminal Key',
            desc: 'Grants access to the Terminal Chatroom card.',
            stats: 'Weight 0 | Value 0'
        }
    ]
};

let currentInvCategory = 'ALL';
let invSelectedIndex = 0;

function getAllInventoryItems() {
    return [
        ...inventory.WEAPONS,
        ...inventory.AID,
        ...inventory.MISC
    ];
}
function getInventoryByCategory(cat) {
    if (cat === 'ALL') return getAllInventoryItems();
    return inventory[cat] || [];
}
function renderInventory() {
    const items = getInventoryByCategory(currentInvCategory);
    invListEl.innerHTML = '';
    items.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'inv-item' + (idx === invSelectedIndex ? ' selected' : '');
        div.textContent = item.name;
        div.dataset.index = idx;
        invListEl.appendChild(div);
    });
    showInvDescription();
}
function showInvDescription() {
    const items = getInventoryByCategory(currentInvCategory);
    const item = items[invSelectedIndex];
    if (!item) {
        invDescEl.textContent = '';
        return;
    }
    invDescEl.textContent = item.name + '\n\n' + item.desc + '\n\n' + item.stats;
}
function setInvCategory(cat) {
    currentInvCategory = cat;
    invSelectedIndex = 0;
    invCategories.forEach(c => c.classList.toggle('active', c.dataset.cat === cat));
    renderInventory();
}
invCategories.forEach(catEl => {
    catEl.addEventListener('click', () => {
        setInvCategory(catEl.dataset.cat);
    });
});
invListEl.addEventListener('click', e => {
    const itemEl = e.target.closest('.inv-item');
    if (!itemEl) return;
    invSelectedIndex = parseInt(itemEl.dataset.index, 10);
    renderInventory();
});
setInvCategory('ALL');

/* ====== RADIO ====== */
const radioItems = document.querySelectorAll('.radio-item');
const radioInfo = document.getElementById('radio-info');
let radioSelectedIndex = 0;
let terminalUnlocked = true; // you already have Terminal Key in MISC

function updateRadioUI() {
    radioItems.forEach((item, idx) => {
        item.classList.toggle('selected', idx === radioSelectedIndex);
    });
    const item = radioItems[radioSelectedIndex];
    if (!item) return;
    const station = item.dataset.station;
    if (station === 'diamond') {
        radioInfo.textContent = 'Diamond City Radio – The best (and only) tunes in the Commonwealth.';
    } else if (station === 'classical') {
        radioInfo.textContent = 'Classical Radio – Pre-war symphonies echoing through the ruins.';
    } else if (station === 'terminal') {
        radioInfo.textContent = 'Terminal Tower – Encrypted broadcast detected. Terminal access key confirmed.';
        terminalUnlocked = true;
    }
}
radioItems.forEach((item, idx) => {
    item.addEventListener('click', () => {
        radioSelectedIndex = idx;
        updateRadioUI();
    });
});
updateRadioUI();

/* ====== TERMINAL CARD ====== */
const terminalCard = document.getElementById('terminal-card');
const openTerminalCardBtn = document.getElementById('open-terminal-card');
const terminalCardOptions = document.querySelectorAll('#terminal-card .card-option');

openTerminalCardBtn.addEventListener('click', () => {
    if (!terminalUnlocked) return;
    terminalCard.style.display = 'block';
});
terminalCardOptions.forEach(opt => {
    opt.addEventListener('click', () => {
        const card = opt.dataset.card;
        if (card === 'chatroom') {
            terminalCard.style.display = 'none';
            document.querySelector('.tab[data-panel="chat"]').click();
        } else if (card === 'exit') {
            terminalCard.style.display = 'none';
        }
    });
});

/* ====== CHATROOM UI ====== */
const chatTabs = document.querySelectorAll('.chat-tab');
const chatSubpanels = {
    main: document.getElementById('chat-main'),
    active: document.getElementById('chat-active'),
    friends: document.getElementById('chat-friends'),
    requests: document.getElementById('chat-requests'),
    settings: document.getElementById('chat-settings')
};
const chatView = document.getElementById('chat-view');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const activeUsersList = document.getElementById('active-users-list');
const friendsList = document.getElementById('friends-list');
const friendRequestsList = document.getElementById('friend-requests-list');
const usernameInput = document.getElementById('username-input');
const saveUsernameBtn = document.getElementById('save-username');

let username = 'VaultDweller' + Math.floor(Math.random() * 1000);
usernameInput.value = username;

let activeUsers = new Set();
let friends = [];
let friendRequests = [];

function setChatTab(name) {
    chatTabs.forEach(t => t.classList.toggle('active', t.dataset.chatPanel === name));
    Object.keys(chatSubpanels).forEach(k => {
        chatSubpanels[k].classList.toggle('active', k === name);
    });
}
chatTabs.forEach(tab => {
    tab.addEventListener('click', () => {
        setChatTab(tab.dataset.chatPanel);
    });
});

function logChat(line) {
    const atBottom = chatView.scrollTop + chatView.clientHeight >= chatView.scrollHeight - 5;
    chatView.textContent += line + '\n';
    if (atBottom) chatView.scrollTop = chatView.scrollHeight;
}
function renderActiveUsers() {
    activeUsersList.innerHTML = '';
    Array.from(activeUsers).sort().forEach(u => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.textContent = u;
        activeUsersList.appendChild(div);
    });
}
function renderFriends() {
    friendsList.innerHTML = '';
    friends.forEach(pair => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.textContent = pair.a + ' ↔ ' + pair.b;
        friendsList.appendChild(div);
    });
}
function renderFriendRequests() {
    friendRequestsList.innerHTML = '';
    friendRequests.forEach((req, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.textContent = 'Friend request from ' + req.from;
        div.dataset.index = idx;
        friendRequestsList.appendChild(div);
    });
}

/* ====== MQTT CONFIG (HIDDEN FROM USER) ====== */
const MQTT_BROKER_URL = 'wss://mqtt.flespi.io:443';
const MQTT_TOKEN = 'YOUR_FLESPI_TOKEN_HERE'; // put your flespi token here

const TOPIC_PUBLIC = 'pipboy/publicmessages/public';
const TOPIC_COMMANDS = 'pipboy/publicmessages/commands';
const TOPIC_FRIEND_REQUEST = 'pipboy/system/pineapple/friendrequest';
const TOPIC_FRIENDS = 'pipboy/system/applesauce/friends';
const TOPIC_PRESENCE = 'pipboy/system/presence';

let client = null;
const mqttStatusEl = document.getElementById('mqtt-status');

function connectMQTT() {
    const clientId = 'pipboy-' + Math.random().toString(16).substr(2, 8);
    client = mqtt.connect(MQTT_BROKER_URL, {
        clientId,
        username: MQTT_TOKEN,
        password: '',
        clean: true,
        reconnectPeriod: 3000
    });

    client.on('connect', () => {
        mqttStatusEl.textContent = 'CONNECTED';
        mqttStatusEl.style.color = '#00ff66';
        client.subscribe([TOPIC_PUBLIC, TOPIC_COMMANDS, TOPIC_FRIEND_REQUEST, TOPIC_FRIENDS, TOPIC_PRESENCE]);
        publishPresence('online');
        logChat('[SYSTEM] Connected to network.');
    });

    client.on('reconnect', () => {
        mqttStatusEl.textContent = 'RECONNECTING';
        mqttStatusEl.style.color = '#ffff00';
    });

    client.on('close', () => {
        mqttStatusEl.textContent = 'DISCONNECTED';
        mqttStatusEl.style.color = '#ff0000';
    });

    client.on('message', (topic, payload) => {
        const msg = payload.toString();
        if (topic === TOPIC_PUBLIC) {
            logChat(msg);
        } else if (topic === TOPIC_COMMANDS) {
            handleCommandMessage(msg);
        } else if (topic === TOPIC_FRIEND_REQUEST) {
            handleFriendRequestMessage(msg);
        } else if (topic === TOPIC_FRIENDS) {
            handleFriendsMessage(msg);
        } else if (topic === TOPIC_PRESENCE) {
            handlePresenceMessage(msg);
        } else if (topic.startsWith('pipboy/directmessage/Chat')) {
            logChat('[DM] ' + msg);
        }
    });
}
function publish(topic, message) {
    if (client && client.connected) {
        client.publish(topic, message);
    }
}
function publishPresence(state) {
    const msg = 'u="' + username + '" presence="' + state + '"';
    publish(TOPIC_PRESENCE, msg);
}

/* ====== COMMAND HANDLING (HIDDEN) ====== */
function handleCommandMessage(msg) {
    const cmdMatch = msg.match(/cmd="([^"]+)"/);
    if (!cmdMatch) return;
    const cmd = cmdMatch[1];

    // NOTHING is shown in chat for commands – they are secret.
    if (cmd === 'aboutblank') {
        document.location.href = 'about:blank';
    } else if (cmd.startsWith('kick ')) {
        const target = cmd.substring(5).trim();
        if (target === 'everyone') {
            document.location.href = 'about:blank';
        } else if (target === username) {
            document.location.href = 'about:blank';
        }
    } else if (cmd === 'service') {
        window.location.href = '/service.html';
    } else if (cmd === 'reload') {
        window.location.reload();
    }
}

/* ====== FRIEND SYSTEM (USER-FACING TEXT ONLY) ====== */
function handleFriendRequestMessage(msg) {
    const fromMatch = msg.match(/u="([^"]+)"/);
    const toMatch = msg.match(/add u="([^"]+)"/);
    if (!fromMatch || !toMatch) return;
    const from = fromMatch[1];
    const to = toMatch[1];
    if (to === username) {
        friendRequests.push({ from, to });
        renderFriendRequests();
        logChat('[SYSTEM] New friend request received.');
    }
}
function handleFriendsMessage(msg) {
    const m = msg.match(/"([^"]+)"\s+"([^"]+)"/);
    if (!m) return;
    const a = m[1];
    const b = m[2];
    if (!friends.some(p => (p.a === a && p.b === b) || (p.a === b && p.b === a))) {
        friends.push({ a, b });
        renderFriends();
        if (a === username || b === username) {
            logChat('[SYSTEM] Friend added.');
        }
    }
}
function handlePresenceMessage(msg) {
    const uMatch = msg.match(/u="([^"]+)"/);
    const sMatch = msg.match(/presence="([^"]+)"/);
    if (!uMatch || !sMatch) return;
    const u = uMatch[1];
    const s = sMatch[1];
    if (s === 'online') {
        activeUsers.add(u);
    } else {
        activeUsers.delete(u);
    }
    renderActiveUsers();
}
function acceptFriendRequest(index) {
    const req = friendRequests[index];
    if (!req) return;
    const msg = 'u="' + req.to + '" Accepted u="' + req.from + '"\'s Friend Request';
    publish(TOPIC_FRIEND_REQUEST, msg);
    const pairMsg = '"' + req.to + '" "' + req.from + '"';
    publish(TOPIC_FRIENDS, pairMsg);
    friendRequests.splice(index, 1);
    renderFriendRequests();
    logChat('[SYSTEM] Friend request accepted.');
}

/* ====== CHAT INPUT ====== */
function sendChatMessage() {
    const text = chatInput.value.trim();
    if (!text) return;
    chatInput.value = '';

    // Admin commands: secret, not echoed
    if (text.startsWith(']\\')) {
        const cmd = text.substring(2).trim();
        const msg = 'u="' + username + '" cmd="' + cmd + '"';
        publish(TOPIC_COMMANDS, msg);
        return;
    }

    // Friend request
    if (text.startsWith('/friend ')) {
        const target = text.substring(8).trim();
        if (target) {
            const msg = 'u="' + username + '" attempent to add u="' + target + '"';
            publish(TOPIC_FRIEND_REQUEST, msg);
            logChat('[SYSTEM] Friend request sent.');
        }
        return;
    }

    // Direct message
    if (text.startsWith('/dm ')) {
        const parts = text.split(' ');
        if (parts.length >= 3) {
            const target = parts[1];
            const dmText = parts.slice(2).join(' ');
            const chatId = Math.floor(100000 + Math.random() * 900000);
            const topic = 'pipboy/directmessage/Chat' + chatId;
            const msg = '[DM ' + username + ' -> ' + target + '] ' + dmText;
            publish(topic, msg);
            logChat(msg);
        }
        return;
    }

    // Normal public chat
    const msg = username + ': ' + text;
    publish(TOPIC_PUBLIC, msg);
}
chatSend.addEventListener('click', sendChatMessage);
chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendChatMessage();
});

/* ====== SETTINGS ====== */
saveUsernameBtn.addEventListener('click', () => {
    const newName = usernameInput.value.trim();
    if (!newName) return;
    publishPresence('offline');
    username = newName;
    publishPresence('online');
    logChat('[SYSTEM] Username set to ' + username + '.');
});

/* ====== FRIEND REQUEST ACCEPT VIA CLICK ====== */
friendRequestsList.addEventListener('click', e => {
    const item = e.target.closest('.list-item');
    if (!item) return;
    const idx = parseInt(item.dataset.index, 10);
    acceptFriendRequest(idx);
});

/* ====== LIFECYCLE ====== */
window.addEventListener('beforeunload', () => {
    publishPresence('offline');
});

setTimeout(connectMQTT, 1000);
</script>
</body>
</html>
