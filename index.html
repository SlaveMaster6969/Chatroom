<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pip-Boy 3000 Mk IV – MQTT Chatroom</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    font-family: "Courier New", monospace;
    color: #00ff66;
}

/* Fullscreen shell */
#root {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
}

/* 1280x720 canvas */
#pipboy-screen {
    position: relative;
    width: 1280px;
    height: 720px;
    background: #000;
    overflow: hidden;
}

/* Proportionally scaled border: 930x700 -> 956x720 */
#border-wrapper {
    position: absolute;
    width: 956px;
    height: 720px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

/* Border image */
#monitor-border {
    position: absolute;
    inset: 0;
    background-size: 100% 100%;
    background-position: center;
    background-repeat: no-repeat;
    pointer-events: none;
}

/* Power-off overlay */
#power-off-overlay {
    position: absolute;
    inset: 0;
    background: #000;
    display: none;
}

/* Glass area (scaled from 553x335 at 93,82 -> 568x344 at 95,84 inside 956x720) */
#glass {
    position: absolute;
    left: 95px;
    top: 84px;
    width: 568px;
    height: 344px;
    background: #001900;
    overflow: hidden;
    color: #00ff66;
    text-shadow: 0 0 4px #00ff66;
    box-shadow:
        0 0 25px rgba(0, 255, 102, 0.4),
        inset 0 0 40px rgba(0, 0, 0, 0.9);
    border-radius: 12px;
}

/* CRT curvature */
#glass::before {
    content: "";
    position: absolute;
    inset: -20%;
    background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,0.08), transparent 60%),
        radial-gradient(circle at 0% 50%, rgba(255,255,255,0.05), transparent 55%),
        radial-gradient(circle at 100% 50%, rgba(255,255,255,0.05), transparent 55%);
    mix-blend-mode: screen;
    pointer-events: none;
}

/* Scanline texture */
#screen-bg-on {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    opacity: 0.25;
    mix-blend-mode: screen;
    pointer-events: none;
}

/* Inner frame */
#screen-inner {
    position: absolute;
    inset: 6px;
    border: 2px solid #00ff66;
    padding: 4px;
    box-sizing: border-box;
    animation: flicker 1.6s infinite;
    overflow: hidden;
}

/* Flicker */
@keyframes flicker {
    0% { opacity: 0.95; }
    5% { opacity: 0.7; }
    10% { opacity: 0.98; }
    15% { opacity: 0.6; }
    20% { opacity: 0.95; }
    25% { opacity: 0.8; }
    30% { opacity: 0.99; }
    35% { opacity: 0.7; }
    40% { opacity: 0.95; }
    100% { opacity: 0.95; }
}

/* Scanline bar */
.scanline {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(to bottom, rgba(0,255,102,0.4), transparent);
    animation: scan 2.2s linear infinite;
    pointer-events: none;
}

@keyframes scan {
    0% { top: -2px; }
    100% { top: 100%; }
}

/* Glow pulse */
@keyframes glowPulse {
    0% { box-shadow: 0 0 4px #00ff66; }
    50% { box-shadow: 0 0 12px #00ff66; }
    100% { box-shadow: 0 0 4px #00ff66; }
}

/* Startup screen */
#startup-screen {
    position: absolute;
    inset: 0;
    padding: 6px;
    box-sizing: border-box;
    font-size: 13px;
    line-height: 1.4;
    white-space: pre;
}

/* Main UI */
#main-ui {
    position: absolute;
    inset: 0;
    display: none;
    font-size: 13px; /* hybrid scale */
}

/* Top bar */
#top-bar {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    margin-bottom: 3px;
}

#top-bar .section-title {
    font-weight: bold;
    letter-spacing: 2px;
}

/* Tabs STAT/INV/DATA/MAP/RADIO */
#pip-tabs {
    display: flex;
    gap: 3px;
    margin-bottom: 3px;
    font-size: 11px;
}

.pip-tab {
    padding: 2px 7px;
    border: 1px solid #00ff66;
    cursor: pointer;
    transition: background 0.12s, color 0.12s, transform 0.08s;
}

.pip-tab:hover {
    transform: translateY(-1px);
}

.pip-tab.active {
    background: #00ff66;
    color: #001900;
    animation: glowPulse 1.2s infinite;
}

/* Content layout */
#content-area {
    position: absolute;
    left: 0;
    right: 0;
    top: 30px;
    bottom: 0;
    display: flex;
}

/* Left menu */
#left-menu {
    width: 130px;
    border-right: 1px solid #00ff66;
    padding-right: 3px;
    box-sizing: border-box;
    font-size: 11px;
}

.left-menu-section-title {
    font-size: 10px;
    margin-bottom: 2px;
    opacity: 0.8;
}

.left-menu-item {
    padding: 2px 2px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
}

.left-menu-item.selected {
    background: #00ff66;
    color: #001900;
}

/* Main panel */
#main-panel {
    flex: 1;
    padding-left: 5px;
    box-sizing: border-box;
    font-size: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.panel {
    display: none;
    flex: 1;
    overflow: hidden;
}

.panel.active {
    display: flex;
    flex-direction: column;
}

/* STAT panel */
#stat-panel-top {
    display: flex;
    flex: 1;
}

#stat-vaultboy {
    width: 120px;
    border-right: 1px solid #00ff66;
    padding-right: 4px;
    box-sizing: border-box;
}

#stat-vaultboy-box {
    width: 100%;
    height: 135px;
    border: 1px solid #00ff66;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
}

#stat-limbs {
    font-size: 9px;
    margin-top: 4px;
}

#stat-bars {
    flex: 1;
    padding-left: 6px;
    box-sizing: border-box;
}

.stat-bar {
    margin-bottom: 4px;
}

.stat-bar-label {
    font-size: 10px;
    margin-bottom: 1px;
}

.stat-bar-track {
    width: 100%;
    height: 6px;
    border: 1px solid #00ff66;
    box-sizing: border-box;
    position: relative;
}

.stat-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background: #00ff66;
}

/* Section headers */
.section-header {
    font-size: 12px;
    margin-bottom: 2px;
}

.section-subheader {
    font-size: 11px;
    opacity: 0.8;
    margin-bottom: 4px;
}

/* Inventory */
#inv-list {
    flex: 1;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    overflow-y: auto;
}

.inv-item {
    padding: 1px 2px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
}

.inv-item.selected {
    background: #00ff66;
    color: #001900;
}

#inv-description {
    margin-top: 4px;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    min-height: 40px;
    white-space: pre-wrap;
}

/* Data */
#data-list {
    flex: 1;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    overflow-y: auto;
}

.data-item {
    padding: 1px 2px;
}

/* Map */
#map-grid {
    flex: 1;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: 1px;
}

.map-cell {
    border: 1px solid #003300;
    background: #001500;
}

/* Radio */
#radio-stations {
    flex: 1;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    overflow-y: auto;
}

.radio-station {
    padding: 1px 2px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
}

.radio-station.selected {
    background: #00ff66;
    color: #001900;
}

#radio-info {
    margin-top: 4px;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    min-height: 40px;
    white-space: pre-wrap;
}

/* Terminal card overlay */
#terminal-card-ui {
    position: absolute;
    inset: 0;
    background: #001900;
    display: none;
    padding: 10px;
    box-sizing: border-box;
    text-align: center;
    font-size: 13px;
}

#terminal-card-title {
    font-size: 14px;
    margin-bottom: 6px;
}

#terminal-card-list {
    margin-top: 10px;
    display: inline-block;
    text-align: left;
}

.terminal-card-item {
    padding: 2px 4px;
    border: 1px solid #00ff66;
    margin-bottom: 4px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s, transform 0.08s;
}

.terminal-card-item:hover {
    transform: translateX(2px);
}

.terminal-card-item.selected {
    background: #00ff66;
    color: #001900;
    animation: glowPulse 1.2s infinite;
}

/* Chatroom */
#chat-panel {
    font-size: 12px;
}

#chat-tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 2px;
}

.chat-tab {
    padding: 1px 4px;
    border: 1px solid #00ff66;
    cursor: pointer;
    font-size: 11px;
    transition: background 0.12s, color 0.12s;
}

.chat-tab.active {
    background: #00ff66;
    color: #001900;
}

.chat-subpanel {
    display: none;
    flex: 1;
    overflow: hidden;
}

.chat-subpanel.active {
    display: flex;
    flex-direction: column;
}

/* Main chat */
#chat-view {
    flex: 1;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    overflow-y: auto;
    white-space: pre-wrap;
}

#chat-input-row {
    display: flex;
    margin-top: 2px;
}

#chat-input {
    flex: 1;
    background: transparent;
    border: 1px solid #00ff66;
    color: #00ff66;
    font-family: inherit;
    font-size: 12px;
    padding: 2px;
    outline: none;
}

#chat-send {
    margin-left: 4px;
    padding: 2px 8px;
    border: 1px solid #00ff66;
    background: transparent;
    color: #00ff66;
    cursor: pointer;
    font-size: 12px;
}

/* Lists */
.list-view {
    flex: 1;
    border: 1px solid #00ff66;
    padding: 2px;
    box-sizing: border-box;
    overflow-y: auto;
}

.list-item {
    padding: 1px 2px;
}

.list-item.selected {
    background: #00ff66;
    color: #001900;
}

/* Settings */
#settings-form label {
    display: block;
    margin-bottom: 4px;
}

#settings-form input {
    background: transparent;
    border: 1px solid #00ff66;
    color: #00ff66;
    font-family: inherit;
    font-size: 12px;
    padding: 2px;
    outline: none;
    width: 220px;
}

#settings-form button {
    margin-top: 4px;
    padding: 2px 8px;
    border: 1px solid #00ff66;
    background: transparent;
    color: #00ff66;
    cursor: pointer;
    font-size: 12px;
}

/* Scrollbars */
::-webkit-scrollbar {
    width: 6px;
}
::-webkit-scrollbar-track {
    background: #001900;
}
::-webkit-scrollbar-thumb {
    background: #00ff66;
}
</style>
</head>
<body>
<div id="root">
    <div id="pipboy-screen">
        <div id="border-wrapper">
            <div id="monitor-border"></div>
            <div id="power-off-overlay"></div>

            <div id="glass">
                <div id="screen-bg-on"></div>
                <div id="screen-inner">
                    <div class="scanline"></div>

                    <!-- STARTUP -->
                    <div id="startup-screen">
*****PIP-OS(R) V7.1.0.8*****
COPYRIGHT 2075 ROBCO(R)
LOADER V1.1
EXEC VERSION 41.10
64k RAM SYSTEM
38911 BYTES FREE
NO HOLOTAPE FOUND
LOAD ROM(1): DEITRIX 303
                    </div>

                    <!-- TERMINAL CARD -->
                    <div id="terminal-card-ui">
ROBCO INDUSTRIES (TM) TERMLINK
------------------------------------------------
SELECT A CARD

                        <div id="terminal-card-list">
                            <div class="terminal-card-item selected" data-card="chatroom">TERMINAL CHATROOM</div>
                        </div>
                        <div style="margin-top:8px;font-size:11px;">
                            Use ↑/↓ to select, ENTER or click to load.
                        </div>
                    </div>

                    <!-- MAIN UI -->
                    <div id="main-ui">
                        <div id="top-bar">
                            <div class="section-title">PIP-BOY 3000 MK IV</div>
                            <div>STATUS: <span id="mqtt-status">DISCONNECTED</span></div>
                        </div>

                        <div id="pip-tabs">
                            <div class="pip-tab active" data-tab="stat">STAT</div>
                            <div class="pip-tab" data-tab="inv">INV</div>
                            <div class="pip-tab" data-tab="data">DATA</div>
                            <div class="pip-tab" data-tab="map">MAP</div>
                            <div class="pip-tab" data-tab="radio">RADIO</div>
                        </div>

                        <div id="content-area">
                            <!-- LEFT MENU -->
                            <div id="left-menu">
                                <div class="left-menu-section-title" id="left-menu-title">STATUS</div>
                                <div class="left-menu-item selected" data-menu="stat-status">STATUS</div>
                                <div class="left-menu-item" data-menu="stat-special">SPECIAL</div>
                                <div class="left-menu-item" data-menu="stat-perks">PERKS</div>
                                <div class="left-menu-item" data-menu="stat-effects">EFFECTS</div>
                            </div>

                            <!-- MAIN PANEL -->
                            <div id="main-panel">
                                <!-- STAT -->
                                <div class="panel active" data-panel="stat">
                                    <div id="stat-panel-top">
                                        <div id="stat-vaultboy">
                                            <div id="stat-vaultboy-box">
                                                VAULT-TEC
                                                <br>ASSISTED
                                                <br>TARGETING
                                                <br>SYSTEM
                                            </div>
                                            <div style="font-size:10px;">
                                                HP: <span id="stat-hp">100</span>/100<br>
                                                AP: <span id="stat-ap">100</span>/100<br>
                                                RAD: <span id="stat-rad">0</span>
                                            </div>
                                            <div id="stat-limbs">
                                                HEAD: OK<br>
                                                TORSO: OK<br>
                                                L ARM: OK<br>
                                                R ARM: OK<br>
                                                L LEG: OK<br>
                                                R LEG: OK
                                            </div>
                                        </div>
                                        <div id="stat-bars">
                                            <div class="stat-bar">
                                                <div class="stat-bar-label">HP</div>
                                                <div class="stat-bar-track">
                                                    <div class="stat-bar-fill" id="bar-hp" style="width:100%;"></div>
                                                </div>
                                            </div>
                                            <div class="stat-bar">
                                                <div class="stat-bar-label">AP</div>
                                                <div class="stat-bar-track">
                                                    <div class="stat-bar-fill" id="bar-ap" style="width:100%;"></div>
                                                </div>
                                            </div>
                                            <div class="stat-bar">
                                                <div class="stat-bar-label">RADS</div>
                                                <div class="stat-bar-track">
                                                    <div class="stat-bar-fill" id="bar-rad" style="width:0%;"></div>
                                                </div>
                                            </div>
                                            <div style="margin-top:6px;font-size:11px;">
                                                LVL: <span id="stat-lvl">1</span>   XP: <span id="stat-xp">0</span>/100
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- INV -->
                                <div class="panel" data-panel="inv">
                                    <div class="section-header">INVENTORY</div>
                                    <div class="section-subheader" id="inv-category-label">ALL</div>
                                    <div id="inv-list"></div>
                                    <div id="inv-description"></div>
                                </div>

                                <!-- DATA -->
                                <div class="panel" data-panel="data">
                                    <div class="section-header">DATA</div>
                                    <div class="section-subheader">QUESTS</div>
                                    <div id="data-list">
                                        <div class="data-item">Out of Time – Leave Vault 111.</div>
                                        <div class="data-item">Jewel of the Commonwealth – Find Nick Valentine.</div>
                                        <div class="data-item">Unlikely Valentine – Rescue Nick from Park Street Station.</div>
                                        <div class="data-item">MQTT: Establish Connection – Connect to the Pip-Boy network.</div>
                                        <div class="data-item">MQTT: Sync Friends – Exchange friend data with the network.</div>
                                        <div class="data-item">MQTT: Secure the Chatroom – Keep the wasteland chatter under control.</div>
                                    </div>
                                </div>

                                <!-- MAP -->
                                <div class="panel" data-panel="map">
                                    <div class="section-header">MAP</div>
                                    <div class="section-subheader">LOCAL MAP</div>
                                    <div id="map-grid">
                                        <!-- 10x6 grid -->
                                        <!-- row 1 -->
                                        <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
                                        <!-- row 2 -->
                                        <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
                                        <!-- row 3 -->
                                        <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
                                        <!-- row 4 -->
                                        <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
                                        <!-- row 5 -->
                                        <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
                                        <!-- row 6 -->
                                        <div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div><div class="map-cell"></div>
                                    </div>
                                </div>

                                <!-- RADIO -->
                                <div class="panel" data-panel="radio" id="radio-panel">
                                    <div class="section-header">RADIO</div>
                                    <div class="section-subheader">AVAILABLE STATIONS</div>
                                    <div id="radio-stations">
                                        <div class="radio-station selected" data-station="diamond">Diamond City Radio</div>
                                        <div class="radio-station" data-station="classical">Classical Radio</div>
                                        <div class="radio-station" data-station="terminal">Terminal Tower</div>
                                    </div>
                                    <div id="radio-info">
Diamond City Radio – The best (and only) tunes in the Commonwealth.
                                    </div>
                                </div>

                                <!-- CHATROOM -->
                                <div class="panel" data-panel="chat" id="chat-panel">
                                    <div class="section-header">TERMINAL CHATROOM</div>
                                    <div class="section-subheader">PIP-BOY NETWORK INTERFACE</div>

                                    <div id="chat-tabs">
                                        <div class="chat-tab active" data-chat-tab="main">Main Chatroom</div>
                                        <div class="chat-tab" data-chat-tab="active">Active Users</div>
                                        <div class="chat-tab" data-chat-tab="friends">Friends</div>
                                        <div class="chat-tab" data-chat-tab="requests">Friend Requests</div>
                                        <div class="chat-tab" data-chat-tab="settings">Settings</div>
                                    </div>

                                    <!-- MAIN CHAT -->
                                    <div class="chat-subpanel active" data-chat-panel="main">
                                        <div id="chat-view"></div>
                                        <div id="chat-input-row">
                                            <input id="chat-input" type="text" placeholder="Type message (]\ for admin, /friend, /dm)..." />
                                            <button id="chat-send">SEND</button>
                                        </div>
                                    </div>

                                    <!-- ACTIVE USERS -->
                                    <div class="chat-subpanel" data-chat-panel="active">
                                        <div class="list-view" id="active-users-list"></div>
                                    </div>

                                    <!-- FRIENDS -->
                                    <div class="chat-subpanel" data-chat-panel="friends">
                                        <div class="list-view" id="friends-list"></div>
                                    </div>

                                    <!-- FRIEND REQUESTS -->
                                    <div class="chat-subpanel" data-chat-panel="requests">
                                        <div class="list-view" id="friend-requests-list"></div>
                                    </div>

                                    <!-- SETTINGS -->
                                    <div class="chat-subpanel" data-chat-panel="settings">
                                        <div id="settings-form">
                                            <label>
                                                Username:
                                                <input type="text" id="username-input" placeholder="Enter username" />
                                            </label>
                                            <button id="save-username">Set Username</button>
                                            <div style="margin-top:6px;font-size:11px;">
                                                Add friend: <code>/friend username</code><br>
                                                Direct message: <code>/dm username message...</code><br>
                                                Admin commands (from privileged client):<br>
                                                <code>]\aboutblank</code>, <code>]\kick username</code>, <code>]\kick everyone</code>, <code>]\service</code>, <code>]\reload</code>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div> <!-- main-panel -->
                        </div> <!-- content-area -->
                    </div> <!-- main-ui -->
                </div> <!-- screen-inner -->
            </div> <!-- glass -->
        </div> <!-- border-wrapper -->
    </div> <!-- pipboy-screen -->
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
(function() {
    const monitorBorder = document.getElementById('monitor-border');
    const powerOffOverlay = document.getElementById('power-off-overlay');
    const screenBgOn = document.getElementById('screen-bg-on');
    const startupScreen = document.getElementById('startup-screen');
    const mainUI = document.getElementById('main-ui');
    const mqttStatusEl = document.getElementById('mqtt-status');
    const terminalCardUI = document.getElementById('terminal-card-ui');

    const IMG_MONITOR_ON = 'assets/monitorborder.png';
    const IMG_MONITOR_OFF = 'assets/monitorborder-off.png';
    const IMG_BG_ON = 'assets/bg-on.png';
    const IMG_BG_OFF = 'assets/bg-off.png';

    function setPower(on) {
        if (on) {
            monitorBorder.style.backgroundImage = 'url(' + IMG_MONITOR_ON + ')';
            screenBgOn.style.backgroundImage = 'url(' + IMG_BG_ON + ')';
            powerOffOverlay.style.display = 'none';
        } else {
            monitorBorder.style.backgroundImage = 'url(' + IMG_MONITOR_OFF + ')';
            screenBgOn.style.backgroundImage = 'url(' + IMG_BG_OFF + ')';
            powerOffOverlay.style.display = 'block';
        }
    }

    setPower(true);

    setTimeout(() => {
        startupScreen.style.display = 'none';
        mainUI.style.display = 'block';
    }, 3500);

    /* Tabs */
    const pipTabs = document.querySelectorAll('.pip-tab');
    const panels = document.querySelectorAll('.panel[data-panel]');
    pipTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.getAttribute('data-tab');
            pipTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            panels.forEach(p => {
                p.classList.toggle('active', p.getAttribute('data-panel') === target);
            });
            updateLeftMenuForTab(target);
        });
    });

    /* Left menu */
    const leftMenu = document.getElementById('left-menu');
    const leftMenuTitle = document.getElementById('left-menu-title');
    let leftMenuItems = [];
    let leftMenuIndex = 0;

    const leftMenuConfig = {
        stat: {
            title: 'STATUS',
            items: [
                { id: 'stat-status', label: 'STATUS' },
                { id: 'stat-special', label: 'SPECIAL' },
                { id: 'stat-perks', label: 'PERKS' },
                { id: 'stat-effects', label: 'EFFECTS' }
            ]
        },
        inv: {
            title: 'INVENTORY',
            items: [
                { id: 'inv-all', label: 'ALL' },
                { id: 'inv-weapons', label: 'WEAPONS' },
                { id: 'inv-aid', label: 'AID' },
                { id: 'inv-misc', label: 'MISC' }
            ]
        },
        data: {
            title: 'DATA',
            items: [
                { id: 'data-quests', label: 'QUESTS' },
                { id: 'data-workshops', label: 'WORKSHOPS' },
                { id: 'data-stats', label: 'STATS' }
            ]
        },
        map: {
            title: 'MAP',
            items: [
                { id: 'map-local', label: 'LOCAL MAP' },
                { id: 'map-world', label: 'WORLD MAP' }
            ]
        },
        radio: {
            title: 'RADIO',
            items: [
                { id: 'radio-stations', label: 'STATIONS' }
            ]
        },
        chat: {
            title: 'CHATROOM',
            items: [
                { id: 'chat-main', label: 'MAIN' },
                { id: 'chat-users', label: 'USERS' },
                { id: 'chat-friends', label: 'FRIENDS' },
                { id: 'chat-requests', label: 'REQUESTS' },
                { id: 'chat-settings', label: 'SETTINGS' }
            ]
        }
    };

    function updateLeftMenuForTab(tab) {
        const cfg = leftMenuConfig[tab] || leftMenuConfig['stat'];
        leftMenuTitle.textContent = cfg.title;
        leftMenu.innerHTML = '<div class="left-menu-section-title" id="left-menu-title">' + cfg.title + '</div>';
        cfg.items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'left-menu-item' + (idx === 0 ? ' selected' : '');
            div.dataset.menu = item.id;
            div.textContent = item.label;
            leftMenu.appendChild(div);
        });
        leftMenuItems = leftMenu.querySelectorAll('.left-menu-item');
        leftMenuIndex = 0;
        leftMenuItems.forEach((item, idx) => {
            item.addEventListener('click', () => {
                leftMenuIndex = idx;
                updateLeftMenuSelection();
                handleLeftMenuAction(tab, item.dataset.menu);
            });
        });
    }

    function updateLeftMenuSelection() {
        leftMenuItems.forEach((item, idx) => {
            item.classList.toggle('selected', idx === leftMenuIndex);
        });
    }

    function handleLeftMenuAction(tab, menuId) {
        if (tab === 'radio') {
            showPanel('radio');
        } else if (tab === 'chat') {
            showPanel('chat');
            if (menuId === 'chat-main') setChatTabByIndex(0);
            else if (menuId === 'chat-users') setChatTabByIndex(1);
            else if (menuId === 'chat-friends') setChatTabByIndex(2);
            else if (menuId === 'chat-requests') setChatTabByIndex(3);
            else if (menuId === 'chat-settings') setChatTabByIndex(4);
        } else {
            showPanel(tab);
        }
    }

    function showPanel(panelName) {
        panels.forEach(p => {
            p.classList.toggle('active', p.getAttribute('data-panel') === panelName);
        });
        pipTabs.forEach(t => {
            t.classList.toggle('active', t.getAttribute('data-tab') === panelName);
        });
        if (panelName === 'chat') {
            updateLeftMenuForTab('chat');
        }
    }

    updateLeftMenuForTab('stat');

    /* Inventory */
    const invListEl = document.getElementById('inv-list');
    const invDescEl = document.getElementById('inv-description');
    const invCategoryLabel = document.getElementById('inv-category-label');

    const inventoryData = {
        weapons: [
            {
                name: '10mm Pistol',
                category: 'WEAPONS',
                desc: 'Standard issue sidearm. Reliable, accurate, and easy to maintain in the wasteland.',
                stats: 'DAM 18 | Fire Rate 46 | Range 83 | ACC 60 | Weight 3.5 | Value 50'
            },
            {
                name: 'Security Baton',
                category: 'WEAPONS',
                desc: 'Vault security baton. Non-lethal in theory, less so in practice.',
                stats: 'DAM 12 | Speed Medium | Weight 2.0 | Value 15'
            },
            {
                name: 'Laser Musket',
                category: 'WEAPONS',
                desc: 'Crank-powered laser rifle favored by the Minutemen.',
                stats: 'DAM 30 | Fire Rate 6 | Range 71 | ACC 69 | Weight 7.0 | Value 75'
            }
        ],
        aid: [
            {
                name: 'Stimpak',
                category: 'AID',
                desc: 'Restores a large amount of health over time. Vault-Tec approved.',
                stats: 'Heals 30% HP | Weight 0.1 | Value 50'
            },
            {
                name: 'RadAway',
                category: 'AID',
                desc: 'Chemically flushes radiation from the bloodstream.',
                stats: '-150 RADS | Weight 0.1 | Value 80'
            },
            {
                name: 'Nuka-Cola',
                category: 'AID',
                desc: 'Ice-cold, mildly radioactive soft drink.',
                stats: '+10 HP | +5 AP | +5 RADS | Weight 0.5 | Value 20'
            }
        ],
        misc: [
            {
                name: 'Pip-Boy Diagnostic Holotape',
                category: 'MISC',
                desc: 'Holotape used to test Pip-Boy subsystems.',
                stats: 'Weight 0 | Value 0'
            }
            // Terminal item added later
        ]
    };

    function buildInventoryList(filter) {
        invListEl.innerHTML = '';
        let items = [];
        if (!filter || filter === 'ALL') {
            items = [
                ...inventoryData.weapons,
                ...inventoryData.aid,
                ...inventoryData.misc
            ];
        } else if (filter === 'WEAPONS') {
            items = inventoryData.weapons;
        } else if (filter === 'AID') {
            items = inventoryData.aid;
        } else if (filter === 'MISC') {
            items = inventoryData.misc;
        }
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'inv-item' + (idx === 0 ? ' selected' : '');
            div.dataset.name = item.name;
            div.dataset.category = item.category;
            div.textContent = item.name;
            invListEl.appendChild(div);
        });
        updateInvSelection();
        showInvDescriptionForSelected();
        const invItems = invListEl.querySelectorAll('.inv-item');
        invItems.forEach((item, idx) => {
            item.addEventListener('click', () => {
                invSelectedIndex = idx;
                updateInvSelection();
                showInvDescriptionForSelected();
                if (item.dataset.name === 'Terminal') {
                    openTerminalCardUI();
                }
            });
        });
    }

    let invSelectedIndex = 0;
    function updateInvSelection() {
        const invItems = invListEl.querySelectorAll('.inv-item');
        invItems.forEach((it, idx) => {
            it.classList.toggle('selected', idx === invSelectedIndex);
        });
    }

    function showInvDescriptionForSelected() {
        const invItems = invListEl.querySelectorAll('.inv-item');
        const itemEl = invItems[invSelectedIndex];
        if (!itemEl) {
            invDescEl.textContent = '';
            return;
        }
        const name = itemEl.dataset.name;
        const category = itemEl.dataset.category;
        const all = [
            ...inventoryData.weapons,
            ...inventoryData.aid,
            ...inventoryData.misc
        ];
        const item = all.find(i => i.name === name && i.category === category);
        if (!item) {
            invDescEl.textContent = '';
            return;
        }
        invDescEl.textContent = item.name + '\n' + item.desc + '\n' + item.stats;
    }

    buildInventoryList('ALL');

    /* Radio */
    const radioStationsEl = document.getElementById('radio-stations');
    const radioInfoEl = document.getElementById('radio-info');
    const radioStations = radioStationsEl.querySelectorAll('.radio-station');
    let radioSelectedIndex = 0;
    let terminalItemUnlocked = false;

    function updateRadioSelection() {
        radioStations.forEach((st, idx) => {
            st.classList.toggle('selected', idx === radioSelectedIndex);
        });
        const st = radioStations[radioSelectedIndex];
        if (!st) return;
        const id = st.dataset.station;
        if (id === 'diamond') {
            radioInfoEl.textContent = 'Diamond City Radio – The best (and only) tunes in the Commonwealth.';
        } else if (id === 'classical') {
            radioInfoEl.textContent = 'Classical Radio – Pre-war symphonies echoing through the ruins.';
        } else if (id === 'terminal') {
            radioInfoEl.textContent = 'Terminal Tower – Encrypted broadcast detected. Receiving data...\nNew item added to MISC: Terminal.';
            unlockTerminalItem();
        }
    }

    radioStations.forEach((st, idx) => {
        st.addEventListener('click', () => {
            radioSelectedIndex = idx;
            updateRadioSelection();
        });
    });

    function unlockTerminalItem() {
        if (terminalItemUnlocked) return;
        terminalItemUnlocked = true;
        const terminalItem = {
            name: 'Terminal',
            category: 'MISC',
            desc: 'Portable access key to the Terminal Chatroom network.',
            stats: 'Weight 0 | Value 0'
        };
        inventoryData.misc.push(terminalItem);
    }

    updateRadioSelection();

    /* Terminal card UI */
    const terminalCardItems = document.querySelectorAll('.terminal-card-item');
    let terminalCardIndex = 0;

    function updateTerminalCardSelection() {
        terminalCardItems.forEach((item, idx) => {
            item.classList.toggle('selected', idx === terminalCardIndex);
        });
    }

    function openTerminalCardUI() {
        mainUI.style.display = 'none';
        terminalCardUI.style.display = 'block';
        terminalCardIndex = 0;
        updateTerminalCardSelection();
    }

    function closeTerminalCardUIToChat() {
        terminalCardUI.style.display = 'none';
        mainUI.style.display = 'block';
        showPanel('chat');
    }

    terminalCardItems.forEach((item, idx) => {
        item.addEventListener('click', () => {
            terminalCardIndex = idx;
            updateTerminalCardSelection();
            if (item.dataset.card === 'chatroom') {
                closeTerminalCardUIToChat();
            }
        });
    });

    /* Chat tabs */
    const chatTabs = document.querySelectorAll('.chat-tab');
    const chatPanels = document.querySelectorAll('.chat-subpanel');
    let chatTabIndex = 0;
    function setChatTabByIndex(idx) {
        chatTabIndex = idx;
        chatTabs.forEach((t, i) => {
            t.classList.toggle('active', i === idx);
        });
        const target = chatTabs[idx].getAttribute('data-chat-tab');
        chatPanels.forEach(p => {
            p.classList.toggle('active', p.getAttribute('data-chat-panel') === target);
        });
    }
    chatTabs.forEach((tab, idx) => {
        tab.addEventListener('click', () => setChatTabByIndex(idx));
    });

    /* Chat state */
    const chatView = document.getElementById('chat-view');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const activeUsersList = document.getElementById('active-users-list');
    const friendsList = document.getElementById('friends-list');
    const friendRequestsList = document.getElementById('friend-requests-list');
    const usernameInput = document.getElementById('username-input');
    const saveUsernameBtn = document.getElementById('save-username');

    let username = 'VaultDweller' + Math.floor(Math.random() * 1000);
    usernameInput.value = username;

    let activeUsers = new Set();
    let friends = [];
    let friendRequests = [];

    function logChat(line) {
        const atBottom = chatView.scrollTop + chatView.clientHeight >= chatView.scrollHeight - 5;
        chatView.textContent += line + '\n';
        if (atBottom) {
            chatView.scrollTop = chatView.scrollHeight;
        }
    }

    function renderActiveUsers() {
        activeUsersList.innerHTML = '';
        Array.from(activeUsers).sort().forEach(u => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = u;
            activeUsersList.appendChild(div);
        });
    }

    function renderFriends() {
        friendsList.innerHTML = '';
        friends.forEach(pair => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = pair.a + ' ↔ ' + pair.b;
            friendsList.appendChild(div);
        });
    }

    function renderFriendRequests() {
        friendRequestsList.innerHTML = '';
        friendRequests.forEach((req, idx) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = req.raw + '  [ENTER to accept if selected]';
            div.dataset.index = idx;
            friendRequestsList.appendChild(div);
        });
    }

    /* MQTT */
    const MQTT_BROKER_URL = 'wss://mqtt.flespi.io:443';
    const MQTT_TOKEN = 'g977bmKI5b1CdmpybeBxi4QfXcrGVva0oUvZc4mb9lhxNkIL3L2pXhIfhI7NP2J0';

    const TOPIC_PUBLIC = 'pipboy/publicmessages/public';
    const TOPIC_COMMANDS = 'pipboy/publicmessages/commands';
    const TOPIC_FRIEND_REQUEST = 'pipboy/system/pineapple/friendrequest';
    const TOPIC_FRIENDS = 'pipboy/system/applesauce/friends';
    const TOPIC_PRESENCE = 'pipboy/system/presence';

    let client = null;

    function connectMQTT() {
        const clientId = 'pipboy-' + Math.random().toString(16).substr(2, 8);
        client = mqtt.connect(MQTT_BROKER_URL, {
            clientId: clientId,
            username: MQTT_TOKEN,
            password: '',
            clean: true,
            reconnectPeriod: 3000
        });

        client.on('connect', () => {
            mqttStatusEl.textContent = 'CONNECTED';
            mqttStatusEl.style.color = '#00ff66';
            client.subscribe([TOPIC_PUBLIC, TOPIC_COMMANDS, TOPIC_FRIEND_REQUEST, TOPIC_FRIENDS, TOPIC_PRESENCE]);
            publishPresence('online');
        });

        client.on('reconnect', () => {
            mqttStatusEl.textContent = 'RECONNECTING';
            mqttStatusEl.style.color = '#ffff00';
        });

        client.on('close', () => {
            mqttStatusEl.textContent = 'DISCONNECTED';
            mqttStatusEl.style.color = '#ff0000';
        });

        client.on('message', (topic, payload) => {
            const msg = payload.toString();
            if (topic === TOPIC_PUBLIC) {
                logChat(msg);
            } else if (topic === TOPIC_COMMANDS) {
                handleCommandMessage(msg);
            } else if (topic === TOPIC_FRIEND_REQUEST) {
                handleFriendRequestMessage(msg);
            } else if (topic === TOPIC_FRIENDS) {
                handleFriendsMessage(msg);
            } else if (topic === TOPIC_PRESENCE) {
                handlePresenceMessage(msg);
            } else if (topic.startsWith('pipboy/directmessage/Chat')) {
                logChat('[DM] ' + msg);
            }
        });
    }

    function publish(topic, message) {
        if (client && client.connected) {
            client.publish(topic, message);
        }
    }

    function publishPresence(state) {
        const msg = 'u="' + username + '" presence="' + state + '"';
        publish(TOPIC_PRESENCE, msg);
    }

    /* Chat send */
    function sendChatMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        chatInput.value = '';

        if (text.startsWith(']\\')) {
            const cmd = text.substring(2).trim();
            const msg = 'u="' + username + '" cmd="' + cmd + '"';
            publish(TOPIC_COMMANDS, msg);
            logChat('[CMD SENT] ' + msg);
        } else if (text.startsWith('/friend ')) {
            const target = text.substring(8).trim();
            if (target) {
                const msg = 'u="' + username + '" attempent to add u="' + target + '"';
                publish(TOPIC_FRIEND_REQUEST, msg);
                logChat('[FRIEND REQUEST SENT] ' + msg);
            }
        } else if (text.startsWith('/dm ')) {
            const parts = text.split(' ');
            if (parts.length >= 3) {
                const target = parts[1];
                const dmText = parts.slice(2).join(' ');
                const chatId = Math.floor(100000 + Math.random() * 900000);
                const topic = 'pipboy/directmessage/Chat' + chatId;
                const msg = '[DM ' + username + ' -> ' + target + '] ' + dmText;
                publish(topic, msg);
                logChat(msg);
            }
        } else {
            const msg = username + ': ' + text;
            publish(TOPIC_PUBLIC, msg);
        }
    }

    chatSend.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });

    /* Commands */
    function handleCommandMessage(msg) {
        const cmdMatch = msg.match(/cmd="([^"]+)"/);
        if (!cmdMatch) return;
        const cmd = cmdMatch[1];

        if (cmd === 'aboutblank') {
            document.location.href = 'about:blank';
        } else if (cmd.startsWith('kick ')) {
            const target = cmd.substring(5).trim();
            if (target === 'everyone') {
                document.location.href = 'about:blank';
            } else {
                if (target === username) {
                    document.location.href = 'about:blank';
                }
            }
        } else if (cmd === 'service') {
            window.location.href = '/service.html';
        } else if (cmd === 'reload') {
            window.location.reload();
        }
    }

    /* Friend system */
    function handleFriendRequestMessage(msg) {
        const fromMatch = msg.match(/u="([^"]+)"/);
        const toMatch = msg.match(/add u="([^"]+)"/);
        if (!fromMatch || !toMatch) return;
        const from = fromMatch[1];
        const to = toMatch[1];

        if (to === username) {
            friendRequests.push({ from, to, raw: msg });
            renderFriendRequests();
        }
    }

    function handleFriendsMessage(msg) {
        const m = msg.match(/"([^"]+)"\s+"([^"]+)"/);
        if (!m) return;
        const a = m[1];
        const b = m[2];
        if (!friends.some(p => (p.a === a && p.b === b) || (p.a === b && p.b === a))) {
            friends.push({ a, b });
            renderFriends();
        }
    }

    function acceptFriendRequest(index) {
        const req = friendRequests[index];
        if (!req) return;
        const msg = 'u="' + req.to + '" Accepted u="' + req.from + '"\'s Friend Request';
        publish(TOPIC_FRIEND_REQUEST, msg);
        const pairMsg = '"' + req.to + '" "' + req.from + '"';
        publish(TOPIC_FRIENDS, pairMsg);
        friendRequests.splice(index, 1);
        renderFriendRequests();
    }

    function handlePresenceMessage(msg) {
        const uMatch = msg.match(/u="([^"]+)"/);
        const sMatch = msg.match(/presence="([^"]+)"/);
        if (!uMatch || !sMatch) return;
        const u = uMatch[1];
        const s = sMatch[1];
        if (s === 'online') {
            activeUsers.add(u);
        } else {
            activeUsers.delete(u);
        }
        renderActiveUsers();
    }

    /* Settings */
    saveUsernameBtn.addEventListener('click', () => {
        const newName = usernameInput.value.trim();
        if (!newName) return;
        publishPresence('offline');
        username = newName;
        publishPresence('online');
        logChat('[SYSTEM] Username set to ' + username);
    });

    /* Keyboard nav */
    document.addEventListener('keydown', (e) => {
        if (terminalCardUI.style.display === 'block') {
            if (e.key === 'ArrowUp') {
                terminalCardIndex = (terminalCardIndex - 1 + terminalCardItems.length) % terminalCardItems.length;
                updateTerminalCardSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                terminalCardIndex = (terminalCardIndex + 1) % terminalCardItems.length;
                updateTerminalCardSelection();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                const item = terminalCardItems[terminalCardIndex];
                if (item.dataset.card === 'chatroom') {
                    closeTerminalCardUIToChat();
                }
                e.preventDefault();
            }
            return;
        }

        const activePanel = document.querySelector('.panel.active');
        const activePanelName = activePanel ? activePanel.getAttribute('data-panel') : '';

        if (activePanelName === 'chat') {
            if (e.key === 'ArrowLeft') {
                setChatTabByIndex((chatTabIndex - 1 + chatTabs.length) % chatTabs.length);
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                setChatTabByIndex((chatTabIndex + 1) % chatTabs.length);
                e.preventDefault();
            } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'Enter') {
                const currentTab = chatTabs[chatTabIndex].getAttribute('data-chat-tab');
                if (currentTab === 'requests') {
                    const items = friendRequestsList.querySelectorAll('.list-item');
                    if (items.length > 0) {
                        let selIndex = -1;
                        items.forEach((it, idx) => {
                            if (it.classList.contains('selected')) selIndex = idx;
                        });
                        if (selIndex === -1) selIndex = 0;
                        if (e.key === 'ArrowUp') {
                            selIndex = (selIndex - 1 + items.length) % items.length;
                        } else if (e.key === 'ArrowDown') {
                            selIndex = (selIndex + 1) % items.length;
                        } else if (e.key === 'Enter') {
                            acceptFriendRequest(selIndex);
                        }
                        items.forEach((it, idx) => {
                            it.classList.toggle('selected', idx === selIndex);
                        });
                        e.preventDefault();
                    }
                }
            }
        } else if (activePanelName === 'inv') {
            const invItems = invListEl.querySelectorAll('.inv-item');
            if (e.key === 'ArrowUp') {
                invSelectedIndex = (invSelectedIndex - 1 + invItems.length) % invItems.length;
                updateInvSelection();
                showInvDescriptionForSelected();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                invSelectedIndex = (invSelectedIndex + 1) % invItems.length;
                updateInvSelection();
                showInvDescriptionForSelected();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                const itemEl = invItems[invSelectedIndex];
                if (itemEl && itemEl.dataset.name === 'Terminal') {
                    openTerminalCardUI();
                }
                e.preventDefault();
            }
        } else if (activePanelName === 'radio') {
            if (e.key === 'ArrowUp') {
                radioSelectedIndex = (radioSelectedIndex - 1 + radioStations.length) % radioStations.length;
                updateRadioSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                radioSelectedIndex = (radioSelectedIndex + 1) % radioStations.length;
                updateRadioSelection();
                e.preventDefault();
            }
        } else {
            if (e.key === 'ArrowUp') {
                leftMenuIndex = (leftMenuIndex - 1 + leftMenuItems.length) % leftMenuItems.length;
                updateLeftMenuSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                leftMenuIndex = (leftMenuIndex + 1) % leftMenuItems.length;
                updateLeftMenuSelection();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                const tab = document.querySelector('.pip-tab.active').getAttribute('data-tab');
                const item = leftMenuItems[leftMenuIndex];
                if (item) {
                    handleLeftMenuAction(tab, item.dataset.menu);
                }
                e.preventDefault();
            }
        }
    });

    window.addEventListener('beforeunload', () => {
        publishPresence('offline');
    });

    setTimeout(connectMQTT, 1000);

    /* Rebuild inventory when switching INV categories via left menu */
    document.addEventListener('click', (e) => {
        const tab = document.querySelector('.pip-tab.active').getAttribute('data-tab');
        if (tab !== 'inv') return;
        if (!e.target.classList.contains('left-menu-item')) return;
        const id = e.target.dataset.menu;
        let filter = 'ALL';
        if (id === 'inv-weapons') filter = 'WEAPONS';
        else if (id === 'inv-aid') filter = 'AID';
        else if (id === 'inv-misc') filter = 'MISC';
        invCategoryLabel.textContent = filter;
        buildInventoryList(filter);
    });

})();
</script>
</body>
</html>
